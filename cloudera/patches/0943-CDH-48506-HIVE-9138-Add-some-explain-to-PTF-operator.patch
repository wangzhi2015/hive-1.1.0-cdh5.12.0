From 4085c400ba3b3194ba64c27dd959de00078de5cb Mon Sep 17 00:00:00 2001
From: Ashutosh Chauhan <hashutosh@apache.org>
Date: Sat, 14 Feb 2015 20:11:11 +0000
Subject: [PATCH 0943/1164] CDH-48506: HIVE-9138 : Add some explain to PTF
 operator (Navis via Ashutosh Chauhan)

Change-Id: I7445c78a3e639e484f8816d73d0318d826d47da7
---
 .../test/resources/testconfiguration.properties    |    1 +
 .../apache/hadoop/hive/ql/exec/ExplainTask.java    |   48 +-
 .../hive/ql/optimizer/ColumnPrunerProcFactory.java |  120 +-
 .../hadoop/hive/ql/optimizer/GenMapRedUtils.java   |    4 +-
 .../hadoop/hive/ql/optimizer/SamplePruner.java     |   14 +-
 .../apache/hadoop/hive/ql/parse/ParseContext.java  |   10 +-
 .../hadoop/hive/ql/parse/SemanticAnalyzer.java     |   10 +-
 .../org/apache/hadoop/hive/ql/plan/FilterDesc.java |   28 +-
 .../org/apache/hadoop/hive/ql/plan/PTFDesc.java    |   33 +-
 .../org/apache/hadoop/hive/ql/plan/PlanUtils.java  |    2 +-
 .../hadoop/hive/ql/plan/ptf/PTFExpressionDef.java  |    6 +
 .../hadoop/hive/ql/plan/ptf/PTFInputDef.java       |   12 +
 .../hadoop/hive/ql/plan/ptf/PTFQueryInputDef.java  |    8 +
 .../ql/plan/ptf/PartitionedTableFunctionDef.java   |   59 +
 .../hive/ql/plan/ptf/WindowExpressionDef.java      |   11 +-
 .../hadoop/hive/ql/plan/ptf/WindowFunctionDef.java |   31 +
 .../hive/ql/plan/ptf/WindowTableFunctionDef.java   |    7 +-
 ql/src/test/queries/clientpositive/ptf_matchpath.q |   33 +
 .../clientpositive/correlationoptimizer12.q.out    |   36 +
 .../test/results/clientpositive/ctas_colname.q.out |   38 +
 .../clientpositive/groupby_grouping_window.q.out   |   19 +
 .../clientpositive/groupby_resolution.q.out        |   19 +
 ql/src/test/results/clientpositive/ptf.q.out       | 1205 +++++++++++++++++++
 .../results/clientpositive/ptf_matchpath.q.out     |  245 +++-
 .../results/clientpositive/ptf_streaming.q.out     |  749 ++++++++++++
 .../results/clientpositive/ptfgroupbyjoin.q.out    |   54 +
 .../results/clientpositive/quotedid_basic.q.out    |   38 +
 ql/src/test/results/clientpositive/sample10.q.out  |    1 +
 ql/src/test/results/clientpositive/sample2.q.out   |    1 +
 ql/src/test/results/clientpositive/sample4.q.out   |    1 +
 ql/src/test/results/clientpositive/sample6.q.out   |    5 +
 ql/src/test/results/clientpositive/sample9.q.out   |    1 +
 .../results/clientpositive/smb_mapjoin_11.q.out    |    2 +
 .../clientpositive/spark/groupby_resolution.q.out  |   19 +
 ql/src/test/results/clientpositive/spark/ptf.q.out | 1213 ++++++++++++++++++++
 .../clientpositive/spark/ptf_matchpath.q.out       |  263 ++++-
 .../clientpositive/spark/ptf_streaming.q.out       |  749 ++++++++++++
 .../results/clientpositive/spark/sample10.q.out    |    1 +
 .../results/clientpositive/spark/sample2.q.out     |    1 +
 .../results/clientpositive/spark/sample4.q.out     |    1 +
 .../results/clientpositive/spark/sample6.q.out     |    5 +
 .../results/clientpositive/spark/sample9.q.out     |    1 +
 .../clientpositive/spark/smb_mapjoin_11.q.out      |    2 +
 .../results/clientpositive/spark/subquery_in.q.out |   38 +
 .../clientpositive/spark/vectorized_ptf.q.out      | 1213 ++++++++++++++++++++
 .../test/results/clientpositive/subquery_in.q.out  |   38 +
 .../clientpositive/subquery_in_having.q.out        |   18 +
 .../results/clientpositive/subquery_notin.q.out    |  114 ++
 .../clientpositive/subquery_unqualcolumnrefs.q.out |   76 ++
 ql/src/test/results/clientpositive/tez/ptf.q.out   | 1205 +++++++++++++++++++
 .../results/clientpositive/tez/ptf_matchpath.q.out |  394 +++++++
 .../results/clientpositive/tez/ptf_streaming.q.out |  749 ++++++++++++
 .../results/clientpositive/tez/subquery_in.q.out   |   38 +
 .../clientpositive/tez/vectorized_ptf.q.out        | 1205 +++++++++++++++++++
 .../clientpositive/union_remove_6_subq.q.out       |   18 +
 .../results/clientpositive/vectorized_ptf.q.out    | 1205 +++++++++++++++++++
 .../clientpositive/windowing_streaming.q.out       |   57 +
 57 files changed, 11341 insertions(+), 133 deletions(-)
 create mode 100644 ql/src/test/results/clientpositive/tez/ptf_matchpath.q.out

diff --git a/itests/src/test/resources/testconfiguration.properties b/itests/src/test/resources/testconfiguration.properties
index 53524c9..ee9f4d8 100644
--- a/itests/src/test/resources/testconfiguration.properties
+++ b/itests/src/test/resources/testconfiguration.properties
@@ -144,6 +144,7 @@ minitez.query.files.shared=alter_merge_2_orc.q,\
   orc_vectorization_ppd.q,\
   parallel.q,\
   ptf.q,\
+  ptf_matchpath.q,\
   ptf_streaming.q,\
   sample1.q,\
   schema_evol_stats.q,\
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/exec/ExplainTask.java b/ql/src/java/org/apache/hadoop/hive/ql/exec/ExplainTask.java
index daf6cb8..149f911 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/exec/ExplainTask.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/exec/ExplainTask.java
@@ -33,7 +33,6 @@
 import java.util.HashMap;
 import java.util.HashSet;
 import java.util.LinkedHashMap;
-import java.util.LinkedList;
 import java.util.List;
 import java.util.Map;
 import java.util.Map.Entry;
@@ -478,11 +477,11 @@ else if (ent.getValue() instanceof Map) {
           json.put(ent.getKey().toString(), ent.getValue().toString());
         }
       }
-      else if (ent.getValue() instanceof Serializable) {
+      else if (ent.getValue() != null) {
         if (out != null) {
           out.println();
         }
-        JSONObject jsonOut = outputPlan((Serializable) ent.getValue(), out,
+        JSONObject jsonOut = outputPlan(ent.getValue(), out,
             extended, jsonOutput, jsonOutput ? 0 : indent + 2);
         if (jsonOutput) {
           json.put(ent.getKey().toString(), jsonOut);
@@ -518,11 +517,11 @@ private JSONArray outputList(List<?> l, PrintStream out, boolean hasHeader,
         }
         nl = true;
       }
-      else if (o instanceof Serializable) {
+      else {
         if (first_el && (out != null) && hasHeader) {
           out.println();
         }
-        JSONObject jsonOut = outputPlan((Serializable) o, out, extended,
+        JSONObject jsonOut = outputPlan(o, out, extended,
             jsonOutput, jsonOutput ? 0 : (hasHeader ? indent + 2 : indent));
         if (jsonOutput) {
           outputArray.put(jsonOut);
@@ -553,12 +552,12 @@ private boolean isPrintable(Object val) {
     return false;
   }
 
-  private JSONObject outputPlan(Serializable work,
+  private JSONObject outputPlan(Object work,
       PrintStream out, boolean extended, boolean jsonOutput, int indent) throws Exception {
     return outputPlan(work, out, extended, jsonOutput, indent, "");
   }
 
-  private JSONObject outputPlan(Serializable work, PrintStream out,
+  private JSONObject outputPlan(Object work, PrintStream out,
       boolean extended, boolean jsonOutput, int indent, String appendToHeader) throws Exception {
     // Check if work has an explain annotation
     Annotation note = AnnotationUtils.getAnnotation(work.getClass(), Explain.class);
@@ -678,7 +677,7 @@ private JSONObject outputPlan(Serializable work, PrintStream out,
           }
 
           // Try this as a map
-          try {
+          if (val instanceof Map) {
             // Go through the map and print out the stuff
             Map<?, ?> mp = (Map<?, ?>) val;
 
@@ -692,22 +691,10 @@ private JSONObject outputPlan(Serializable work, PrintStream out,
             }
             continue;
           }
-          catch (ClassCastException ce) {
-            // Ignore - all this means is that this is not a map
-          }
 
           // Try this as a list
-          try {
-            List l;
-
-            try {
-              l = (List) val;
-            } catch (ClassCastException e) {
-              Set s = (Set) val;
-              l = new LinkedList();
-              l.addAll(s);
-            }
-
+          if (val instanceof List || val instanceof Set) {
+            List l = val instanceof List ? (List)val : new ArrayList((Set)val);
             if (out != null && !skipHeader && l != null && !l.isEmpty()) {
               out.print(header);
             }
@@ -720,18 +707,13 @@ private JSONObject outputPlan(Serializable work, PrintStream out,
 
             continue;
           }
-          catch (ClassCastException ce) {
-            // Ignore
-          }
 
           // Finally check if it is serializable
           try {
-            Serializable s = (Serializable) val;
-
             if (!skipHeader && out != null) {
               out.println(header);
             }
-            JSONObject jsonOut = outputPlan(s, out, extended, jsonOutput, ind);
+            JSONObject jsonOut = outputPlan(val, out, extended, jsonOutput, ind);
             if (jsonOutput) {
               if (!skipHeader) {
                 json.put(header, jsonOut);
@@ -779,7 +761,7 @@ private boolean shouldPrint(Explain exp, Object val) {
     return true;
   }
 
-  private JSONObject outputPlan(Task<? extends Serializable> task,
+  private JSONObject outputPlan(Task<?> task,
       PrintStream out, JSONObject parentJSON, boolean extended,
       boolean jsonOutput, int indent) throws Exception {
 
@@ -805,7 +787,7 @@ private JSONObject outputPlan(Task<? extends Serializable> task,
     return null;
   }
 
-  private JSONObject outputDependencies(Task<? extends Serializable> task,
+  private JSONObject outputDependencies(Task<?> task,
       PrintStream out, JSONObject parentJson, boolean jsonOutput, boolean taskType, int indent)
       throws Exception {
 
@@ -830,7 +812,7 @@ private JSONObject outputDependencies(Task<? extends Serializable> task,
     else {
       StringBuffer s = new StringBuffer();
       first = true;
-      for (Task<? extends Serializable> parent : task.getParentTasks()) {
+      for (Task<?> parent : task.getParentTasks()) {
         if (!first) {
           s.append(", ");
         }
@@ -847,7 +829,7 @@ private JSONObject outputDependencies(Task<? extends Serializable> task,
       }
     }
 
-    Task<? extends Serializable> currBackupTask = task.getBackupTask();
+    Task<?> currBackupTask = task.getBackupTask();
     if (currBackupTask != null) {
       if (out != null) {
         out.print(" has a backup stage: ");
@@ -862,7 +844,7 @@ private JSONObject outputDependencies(Task<? extends Serializable> task,
         && ((ConditionalTask) task).getListTasks() != null) {
       StringBuffer s = new StringBuffer();
       first = true;
-      for (Task<? extends Serializable> con : ((ConditionalTask) task).getListTasks()) {
+      for (Task<?> con : ((ConditionalTask) task).getListTasks()) {
         if (!first) {
           s.append(", ");
         }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java b/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
index 45b4a42..877a753 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
@@ -53,6 +53,7 @@
 import org.apache.hadoop.hive.ql.lib.NodeProcessor;
 import org.apache.hadoop.hive.ql.lib.NodeProcessorCtx;
 import org.apache.hadoop.hive.ql.metadata.VirtualColumn;
+import org.apache.hadoop.hive.ql.parse.RowResolver;
 import org.apache.hadoop.hive.ql.parse.SemanticException;
 import org.apache.hadoop.hive.ql.plan.AggregationDesc;
 import org.apache.hadoop.hive.ql.plan.ExprNodeColumnDesc;
@@ -70,6 +71,9 @@
 import org.apache.hadoop.hive.ql.plan.TableScanDesc;
 import org.apache.hadoop.hive.ql.plan.UnionDesc;
 import org.apache.hadoop.hive.ql.plan.ptf.PTFExpressionDef;
+import org.apache.hadoop.hive.ql.plan.ptf.PTFInputDef;
+import org.apache.hadoop.hive.ql.plan.ptf.PartitionedTableFunctionDef;
+import org.apache.hadoop.hive.ql.plan.ptf.ShapeDetails;
 import org.apache.hadoop.hive.ql.plan.ptf.WindowFunctionDef;
 import org.apache.hadoop.hive.ql.plan.ptf.WindowTableFunctionDef;
 import org.apache.hadoop.hive.ql.udf.ptf.Noop;
@@ -297,34 +301,34 @@ public Object process(Node nd, Stack<Node> stack, NodeProcessorCtx ctx,
       PTFDesc conf = op.getConf();
       //Since we cannot know what columns will be needed by a PTF chain,
       //we do not prune columns on PTFOperator for PTF chains.
-      if (!conf.forWindowing() && !Noop.class.isInstance(conf.getFuncDef().getTFunction())) {
+      PartitionedTableFunctionDef funcDef = conf.getFuncDef();
+      if (!conf.forWindowing() && !Noop.class.isInstance(funcDef.getTFunction())) {
         return super.process(nd, stack, cppCtx, nodeOutputs);
       }
-
-      List<String> prunedCols = cppCtx.getPrunedColList(op.getChildOperators().get(0));
-
-      WindowTableFunctionDef def = null;
-      if (conf.forWindowing()) {
-        def = (WindowTableFunctionDef) conf.getFuncDef();
+      
+      //we create a copy of prunedCols to create a list of pruned columns for PTFOperator
+      List<String> prunedCols = 
+          new ArrayList<String>(cppCtx.getPrunedColList(op.getChildOperators().get(0)));
+      if (funcDef instanceof WindowTableFunctionDef) {
+        WindowTableFunctionDef def = (WindowTableFunctionDef) funcDef;
         prunedCols = Utilities.mergeUniqElems(getWindowFunctionColumns(def), prunedCols);
-        prunedCols = prunedColumnsList(prunedCols, def);
       }
+      
+      List<ColumnInfo> newRS = prunedColumnsList(prunedCols, op.getSchema(), funcDef);      
+      
+      op.getSchema().setSignature(new ArrayList<ColumnInfo>(newRS));
 
-      RowSchema oldRS = op.getSchema();
-      ArrayList<ColumnInfo> sig = buildPrunedRR(prunedCols, oldRS);
-      op.getSchema().setSignature(sig);
-
-      prunedCols = def == null ? prunedCols : prunedInputList(prunedCols, def);
-      cppCtx.getPrunedColLists().put(op, prunedCols);
+      ShapeDetails outputShape = funcDef.getStartOfChain().getInput().getOutputShape();
+      cppCtx.getPrunedColLists().put(op, outputShape.getColumnNames());
       return null;
     }
 
-    private static ArrayList<ColumnInfo> buildPrunedRR(List<String> prunedCols,
-        RowSchema oldRS) throws SemanticException{
+    private List<ColumnInfo> buildPrunedRS(List<String> prunedCols, RowSchema oldRS) 
+        throws SemanticException {
       ArrayList<ColumnInfo> sig = new ArrayList<ColumnInfo>();
       HashSet<String> prunedColsSet = new HashSet<String>(prunedCols);
-      for(ColumnInfo cInfo : oldRS.getSignature()) {
-        if ( prunedColsSet.contains(cInfo.getInternalName())) {
+      for (ColumnInfo cInfo : oldRS.getSignature()) {
+        if (prunedColsSet.contains(cInfo.getInternalName())) {
           sig.add(cInfo);
         }
       }
@@ -342,48 +346,74 @@ public Object process(Node nd, Stack<Node> stack, NodeProcessorCtx ctx,
       return columns;
     }
     
+    private RowResolver buildPrunedRR(List<String> prunedCols, RowSchema oldRS)
+        throws SemanticException {
+      RowResolver resolver = new RowResolver();
+      HashSet<String> prunedColsSet = new HashSet<String>(prunedCols);
+      for (ColumnInfo cInfo : oldRS.getSignature()) {
+        if (prunedColsSet.contains(cInfo.getInternalName())) {
+          resolver.put(cInfo.getTabAlias(), cInfo.getAlias(), cInfo);
+        }
+      }
+      return resolver;
+    }
+
     /*
      * add any input columns referenced in WindowFn args or expressions.
      */
-    private ArrayList<String> prunedColumnsList(List<String> prunedCols, 
-        WindowTableFunctionDef tDef) {
-      //we create a copy of prunedCols to create a list of pruned columns for PTFOperator
-      ArrayList<String> mergedColList = new ArrayList<String>(prunedCols);
-      if ( tDef.getWindowFunctions() != null ) {
-        for(WindowFunctionDef wDef : tDef.getWindowFunctions() ) {
-          if ( wDef.getArgs() == null) {
-            continue;
+    private List<ColumnInfo> prunedColumnsList(List<String> prunedCols, RowSchema oldRS,
+        PartitionedTableFunctionDef pDef) throws SemanticException {
+      pDef.getOutputShape().setRr(null);
+      pDef.getOutputShape().setColumnNames(null);
+      if (pDef instanceof WindowTableFunctionDef) {
+        WindowTableFunctionDef tDef = (WindowTableFunctionDef) pDef;
+        if (tDef.getWindowFunctions() != null) {
+          for (WindowFunctionDef wDef : tDef.getWindowFunctions()) {
+            if (wDef.getArgs() == null) {
+              continue;
+            }
+            for (PTFExpressionDef arg : wDef.getArgs()) {
+              ExprNodeDesc exprNode = arg.getExprNode();
+              Utilities.mergeUniqElems(prunedCols, exprNode.getCols());
+            }
+          }
+        }
+        if (tDef.getPartition() != null) {
+          for (PTFExpressionDef col : tDef.getPartition().getExpressions()) {
+            ExprNodeDesc exprNode = col.getExprNode();
+            Utilities.mergeUniqElems(prunedCols, exprNode.getCols());
           }
-          for(PTFExpressionDef arg : wDef.getArgs()) {
-            ExprNodeDesc exprNode = arg.getExprNode();
-            Utilities.mergeUniqElems(mergedColList, exprNode.getCols());
+        }
+        if (tDef.getOrder() != null) {
+          for (PTFExpressionDef col : tDef.getOrder().getExpressions()) {
+            ExprNodeDesc exprNode = col.getExprNode();
+            Utilities.mergeUniqElems(prunedCols, exprNode.getCols());
           }
         }
+      } else {
+        pDef.getOutputShape().setRr(buildPrunedRR(prunedCols, oldRS));
       }
-     if(tDef.getPartition() != null){
-         for(PTFExpressionDef col : tDef.getPartition().getExpressions()){
-           ExprNodeDesc exprNode = col.getExprNode();
-           Utilities.mergeUniqElems(mergedColList, exprNode.getCols());
-         }
-       }
-       if(tDef.getOrder() != null){
-         for(PTFExpressionDef col : tDef.getOrder().getExpressions()){
-           ExprNodeDesc exprNode = col.getExprNode();
-           Utilities.mergeUniqElems(mergedColList, exprNode.getCols());
-         }
-       }
-      return mergedColList;
+      
+      PTFInputDef input = pDef.getInput();
+      if (input instanceof PartitionedTableFunctionDef) {
+        return prunedColumnsList(prunedCols, oldRS, (PartitionedTableFunctionDef)input);
+      }
+      
+      ArrayList<String> inputColumns = prunedInputList(prunedCols, input);
+      input.getOutputShape().setRr(buildPrunedRR(inputColumns, oldRS));
+      input.getOutputShape().setColumnNames(inputColumns);
+
+      return buildPrunedRS(prunedCols, oldRS);
     }
 
     /*
      * from the prunedCols list filter out columns that refer to WindowFns or WindowExprs
      * the returned list is set as the prunedList needed by the PTFOp.
      */
-    private ArrayList<String> prunedInputList(List<String> prunedCols,
-        WindowTableFunctionDef tDef) {
+    private ArrayList<String> prunedInputList(List<String> prunedCols, PTFInputDef tDef) {
       ArrayList<String> prunedInputCols = new ArrayList<String>();
 
-      StructObjectInspector OI = tDef.getInput().getOutputShape().getOI();
+      StructObjectInspector OI = tDef.getOutputShape().getOI();
       for(StructField f : OI.getAllStructFieldRefs()) {
         String fName = f.getFieldName();
         if ( prunedCols.contains(fName)) {
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java b/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java
index c8e492c..c3c01c6 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java
@@ -95,7 +95,7 @@
 import org.apache.hadoop.hive.ql.plan.FetchWork;
 import org.apache.hadoop.hive.ql.plan.FileMergeDesc;
 import org.apache.hadoop.hive.ql.plan.FileSinkDesc;
-import org.apache.hadoop.hive.ql.plan.FilterDesc.sampleDesc;
+import org.apache.hadoop.hive.ql.plan.FilterDesc.SampleDesc;
 import org.apache.hadoop.hive.ql.plan.LoadFileDesc;
 import org.apache.hadoop.hive.ql.plan.LoadTableDesc;
 import org.apache.hadoop.hive.ql.plan.MapWork;
@@ -593,7 +593,7 @@ public static void setMapWork(MapWork plan, ParseContext parseCtx, Set<ReadEntit
       // Later the properties have to come from the partition as opposed
       // to from the table in order to support versioning.
       Path[] paths = null;
-      sampleDesc sampleDescr = parseCtx.getOpToSamplePruner().get(topOp);
+      SampleDesc sampleDescr = parseCtx.getOpToSamplePruner().get(topOp);
 
       // Lookup list bucketing pruner
       Map<String, ExprNodeDesc> partToPruner = parseCtx.getOpToPartToSkewedPruner().get(topOp);
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/optimizer/SamplePruner.java b/ql/src/java/org/apache/hadoop/hive/ql/optimizer/SamplePruner.java
index b0f4b47..37f9473 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/optimizer/SamplePruner.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/optimizer/SamplePruner.java
@@ -48,7 +48,7 @@
 import org.apache.hadoop.hive.ql.parse.ParseContext;
 import org.apache.hadoop.hive.ql.parse.SemanticException;
 import org.apache.hadoop.hive.ql.plan.FilterDesc;
-import org.apache.hadoop.hive.ql.plan.FilterDesc.sampleDesc;
+import org.apache.hadoop.hive.ql.plan.FilterDesc.SampleDesc;
 
 /**
  * The transformation step that does sample pruning.
@@ -61,17 +61,17 @@
    *
    */
   public static class SamplePrunerCtx implements NodeProcessorCtx {
-    HashMap<TableScanOperator, sampleDesc> opToSamplePruner;
+    HashMap<TableScanOperator, SampleDesc> opToSamplePruner;
 
     public SamplePrunerCtx(
-        HashMap<TableScanOperator, sampleDesc> opToSamplePruner) {
+        HashMap<TableScanOperator, SampleDesc> opToSamplePruner) {
       this.opToSamplePruner = opToSamplePruner;
     }
 
     /**
      * @return the opToSamplePruner
      */
-    public HashMap<TableScanOperator, sampleDesc> getOpToSamplePruner() {
+    public HashMap<TableScanOperator, SampleDesc> getOpToSamplePruner() {
       return opToSamplePruner;
     }
 
@@ -80,7 +80,7 @@ public SamplePrunerCtx(
      *          the opToSamplePruner to set
      */
     public void setOpToSamplePruner(
-        HashMap<TableScanOperator, sampleDesc> opToSamplePruner) {
+        HashMap<TableScanOperator, SampleDesc> opToSamplePruner) {
       this.opToSamplePruner = opToSamplePruner;
     }
   }
@@ -135,7 +135,7 @@ public Object process(Node nd, Stack<Node> stack, NodeProcessorCtx procCtx,
         Object... nodeOutputs) throws SemanticException {
       FilterOperator filOp = (FilterOperator) nd;
       FilterDesc filOpDesc = filOp.getConf();
-      sampleDesc sampleDescr = filOpDesc.getSampleDescr();
+      SampleDesc sampleDescr = filOpDesc.getSampleDescr();
 
       if ((sampleDescr == null) || !sampleDescr.getInputPruning()) {
         return null;
@@ -182,7 +182,7 @@ public static NodeProcessor getDefaultProc() {
    * @throws SemanticException
    */
   @SuppressWarnings("nls")
-  public static Path[] prune(Partition part, sampleDesc sampleDescr)
+  public static Path[] prune(Partition part, SampleDesc sampleDescr)
       throws SemanticException {
     int num = sampleDescr.getNumerator();
     int den = sampleDescr.getDenominator();
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java b/ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
index 5cf4d53..619a1c3 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
@@ -44,7 +44,7 @@
 import org.apache.hadoop.hive.ql.optimizer.ppr.PartitionPruner;
 import org.apache.hadoop.hive.ql.optimizer.unionproc.UnionProcContext;
 import org.apache.hadoop.hive.ql.plan.ExprNodeDesc;
-import org.apache.hadoop.hive.ql.plan.FilterDesc.sampleDesc;
+import org.apache.hadoop.hive.ql.plan.FilterDesc.SampleDesc;
 import org.apache.hadoop.hive.ql.plan.LoadFileDesc;
 import org.apache.hadoop.hive.ql.plan.LoadTableDesc;
 import org.apache.hadoop.hive.ql.plan.MapJoinDesc;
@@ -66,7 +66,7 @@
   private ASTNode ast;
   private HashMap<TableScanOperator, ExprNodeDesc> opToPartPruner;
   private HashMap<TableScanOperator, PrunedPartitionList> opToPartList;
-  private HashMap<TableScanOperator, sampleDesc> opToSamplePruner;
+  private HashMap<TableScanOperator, SampleDesc> opToSamplePruner;
   private Map<TableScanOperator, Map<String, ExprNodeDesc>> opToPartToSkewedPruner;
   private HashMap<String, Operator<? extends OperatorDesc>> topOps;
   private Set<JoinOperator> joinOps;
@@ -157,7 +157,7 @@ public ParseContext(
       UnionProcContext uCtx, List<AbstractMapJoinOperator<? extends MapJoinDesc>> listMapJoinOpsNoReducer,
       Map<GroupByOperator, Set<String>> groupOpToInputTables,
       Map<String, PrunedPartitionList> prunedPartitions,
-      HashMap<TableScanOperator, sampleDesc> opToSamplePruner,
+      HashMap<TableScanOperator, SampleDesc> opToSamplePruner,
       GlobalLimitCtx globalLimitCtx,
       HashMap<String, SplitSample> nameToSplitSample,
       HashSet<ReadEntity> semanticInputs, List<Task<? extends Serializable>> rootTasks,
@@ -395,7 +395,7 @@ public void setListMapJoinOpsNoReducer(
   /**
    * @return the opToSamplePruner
    */
-  public HashMap<TableScanOperator, sampleDesc> getOpToSamplePruner() {
+  public HashMap<TableScanOperator, SampleDesc> getOpToSamplePruner() {
     return opToSamplePruner;
   }
 
@@ -404,7 +404,7 @@ public void setListMapJoinOpsNoReducer(
    *          the opToSamplePruner to set
    */
   public void setOpToSamplePruner(
-      HashMap<TableScanOperator, sampleDesc> opToSamplePruner) {
+      HashMap<TableScanOperator, SampleDesc> opToSamplePruner) {
     this.opToSamplePruner = opToSamplePruner;
   }
 
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java b/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
index b0d9854..45cb295 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
@@ -157,7 +157,7 @@
 import org.apache.hadoop.hive.ql.plan.ExtractDesc;
 import org.apache.hadoop.hive.ql.plan.FileSinkDesc;
 import org.apache.hadoop.hive.ql.plan.FilterDesc;
-import org.apache.hadoop.hive.ql.plan.FilterDesc.sampleDesc;
+import org.apache.hadoop.hive.ql.plan.FilterDesc.SampleDesc;
 import org.apache.hadoop.hive.ql.plan.ForwardDesc;
 import org.apache.hadoop.hive.ql.plan.GroupByDesc;
 import org.apache.hadoop.hive.ql.plan.HiveOperation;
@@ -254,7 +254,7 @@
   private int destTableId;
   private UnionProcContext uCtx;
   List<AbstractMapJoinOperator<? extends MapJoinDesc>> listMapJoinOpsNoReducer;
-  private HashMap<TableScanOperator, sampleDesc> opToSamplePruner;
+  private HashMap<TableScanOperator, SampleDesc> opToSamplePruner;
   private final Map<TableScanOperator, Map<String, ExprNodeDesc>> opToPartToSkewedPruner;
   /**
    * a map for the split sampling, from alias to an instance of SplitSample
@@ -313,7 +313,7 @@ public SemanticAnalyzer(HiveConf conf) throws SemanticException {
     super(conf);
     opToPartPruner = new HashMap<TableScanOperator, ExprNodeDesc>();
     opToPartList = new HashMap<TableScanOperator, PrunedPartitionList>();
-    opToSamplePruner = new HashMap<TableScanOperator, sampleDesc>();
+    opToSamplePruner = new HashMap<TableScanOperator, SampleDesc>();
     nameToSplitSample = new HashMap<String, SplitSample>();
     // Must be deterministic order maps - see HIVE-8707
     topOps = new LinkedHashMap<String, Operator<? extends OperatorDesc>>();
@@ -9563,7 +9563,7 @@ private Operator genTablePlan(String alias, QB qb) throws SemanticException {
         ExprNodeDesc samplePredicate = genSamplePredicate(ts, tabBucketCols,
             colsEqual, alias, rwsch, qb.getMetaData(), null);
         FilterDesc filterDesc = new FilterDesc(
-          samplePredicate, true, new sampleDesc(ts.getNumerator(), ts
+          samplePredicate, true, new SampleDesc(ts.getNumerator(), ts
               .getDenominator(), tabBucketCols, true));
         filterDesc.setGenerated(true);
         tableOp = OperatorFactory.getAndMakeChild(filterDesc,
@@ -9606,7 +9606,7 @@ private Operator genTablePlan(String alias, QB qb) throws SemanticException {
             ExprNodeDesc samplePred = genSamplePredicate(tsSample, tab
                 .getBucketCols(), true, alias, rwsch, qb.getMetaData(), null);
             FilterDesc filterDesc = new FilterDesc(samplePred, true,
-              new sampleDesc(tsSample.getNumerator(), tsSample
+              new SampleDesc(tsSample.getNumerator(), tsSample
                 .getDenominator(), tab.getBucketCols(), true));
             filterDesc.setGenerated(true);
             tableOp = OperatorFactory.getAndMakeChild(filterDesc,
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/plan/FilterDesc.java b/ql/src/java/org/apache/hadoop/hive/ql/plan/FilterDesc.java
index 998ca6f..12e698d 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/plan/FilterDesc.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/plan/FilterDesc.java
@@ -31,7 +31,7 @@
   /**
    * sampleDesc is used to keep track of the sampling descriptor.
    */
-  public static class sampleDesc implements Cloneable {
+  public static class SampleDesc implements Cloneable {
     // The numerator of the TABLESAMPLE clause
     private int numerator;
 
@@ -41,11 +41,11 @@
     // Input files can be pruned
     private boolean inputPruning;
 
-    public sampleDesc() {
+    public SampleDesc() {
     }
 
-    public sampleDesc(int numerator, int denominator,
-        List<String> tabBucketCols, boolean inputPruning) {
+    public SampleDesc(int numerator, int denominator,
+                      List<String> tabBucketCols, boolean inputPruning) {
       this.numerator = numerator;
       this.denominator = denominator;
       this.inputPruning = inputPruning;
@@ -65,15 +65,19 @@ public boolean getInputPruning() {
 
     @Override
     public Object clone() {
-      sampleDesc desc = new sampleDesc(numerator, denominator, null, inputPruning);
+      SampleDesc desc = new SampleDesc(numerator, denominator, null, inputPruning);
       return desc;
     }
+    
+    public String toString() {
+      return inputPruning ? "BUCKET " + numerator + " OUT OF " + denominator: null;  
+    }
   }
 
   private static final long serialVersionUID = 1L;
   private org.apache.hadoop.hive.ql.plan.ExprNodeDesc predicate;
   private boolean isSamplingPred;
-  private transient sampleDesc sampleDescr;
+  private transient SampleDesc sampleDescr;
   //Is this a filter that should perform a comparison for sorted searches
   private boolean isSortedFilter;
   private transient boolean isGenerated;
@@ -91,7 +95,7 @@ public FilterDesc(
 
   public FilterDesc(
       final org.apache.hadoop.hive.ql.plan.ExprNodeDesc predicate,
-      boolean isSamplingPred, final sampleDesc sampleDescr) {
+      boolean isSamplingPred, final SampleDesc sampleDescr) {
     this.predicate = predicate;
     this.isSamplingPred = isSamplingPred;
     this.sampleDescr = sampleDescr;
@@ -122,15 +126,19 @@ public void setIsSamplingPred(final boolean isSamplingPred) {
     this.isSamplingPred = isSamplingPred;
   }
 
-  @Explain(displayName = "sampleDesc", normalExplain = false)
-  public sampleDesc getSampleDescr() {
+  public SampleDesc getSampleDescr() {
     return sampleDescr;
   }
 
-  public void setSampleDescr(final sampleDesc sampleDescr) {
+  public void setSampleDescr(final SampleDesc sampleDescr) {
     this.sampleDescr = sampleDescr;
   }
 
+  @Explain(displayName = "sampleDesc", normalExplain = false)
+  public String getSampleDescExpr() {
+    return sampleDescr == null ? null : sampleDescr.toString();
+  }
+
   public boolean isSortedFilter() {
     return isSortedFilter;
   }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDesc.java b/ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDesc.java
index 3ac3245..2f31eed 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDesc.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDesc.java
@@ -22,14 +22,16 @@
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
 import org.apache.hadoop.conf.Configuration;
-import org.apache.hadoop.hive.conf.HiveConf;
 import org.apache.hadoop.hive.ql.exec.PTFUtils;
 import org.apache.hadoop.hive.ql.parse.LeadLagInfo;
-import org.apache.hadoop.hive.ql.parse.PTFInvocationSpec.Order;
-import org.apache.hadoop.hive.ql.parse.PTFInvocationSpec.PTFQueryInputType;
+import org.apache.hadoop.hive.ql.plan.ptf.PTFInputDef;
 import org.apache.hadoop.hive.ql.plan.ptf.PartitionedTableFunctionDef;
 import org.apache.hadoop.hive.ql.plan.ptf.WindowTableFunctionDef;
 
+import java.util.ArrayList;
+import java.util.Collections;
+import java.util.List;
+
 @Explain(displayName = "PTF Operator")
 public class PTFDesc extends AbstractOperatorDesc {
   private static final long serialVersionUID = 1L;
@@ -62,6 +64,19 @@ public PartitionedTableFunctionDef getStartOfChain() {
     return funcDef == null ? null : funcDef.getStartOfChain();
   }
 
+  @Explain(displayName = "Function definitions")
+  public List<PTFInputDef> getFuncDefExplain() {
+    if (funcDef == null) {
+      return null;
+    }
+    List<PTFInputDef> inputs = new ArrayList<PTFInputDef>();
+    for (PTFInputDef current = funcDef; current != null; current = current.getInput()) {
+      inputs.add(current);
+    }
+    Collections.reverse(inputs);
+    return inputs;
+  }
+
   public LeadLagInfo getLlInfo() {
     return llInfo;
   }
@@ -70,10 +85,19 @@ public void setLlInfo(LeadLagInfo llInfo) {
     this.llInfo = llInfo;
   }
 
+  @Explain(displayName = "Lead/Lag information")
+  public String getLlInfoExplain() {
+    if (llInfo != null && llInfo.getLeadLagExprs() != null) {
+      return PlanUtils.getExprListString(llInfo.getLeadLagExprs());
+    }
+    return null;
+  }
+
   public boolean forWindowing() {
-    return funcDef != null && (funcDef instanceof WindowTableFunctionDef);
+    return funcDef instanceof WindowTableFunctionDef;
   }
 
+  @Explain(displayName = "Map-side function", displayOnlyOnTrue = true)
   public boolean isMapSide() {
     return isMapSide;
   }
@@ -89,5 +113,4 @@ public Configuration getCfg() {
   public void setCfg(Configuration cfg) {
     this.cfg = cfg;
   }
-
 }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java b/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java
index aaaf709..b48b627 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java
@@ -929,7 +929,7 @@ public static ReadEntity addInput(Set<ReadEntity> inputs, ReadEntity newInput, b
     return null;
   }
 
-  public static String getExprListString(Collection<ExprNodeDesc> exprs) {
+  public static String getExprListString(Collection<?  extends ExprNodeDesc> exprs) {
     StringBuffer sb = new StringBuffer();
     boolean first = true;
     for (ExprNodeDesc expr: exprs) {
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PTFExpressionDef.java b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PTFExpressionDef.java
index 5d200fb..a0370bf 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PTFExpressionDef.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PTFExpressionDef.java
@@ -20,6 +20,7 @@
 
 import org.apache.hadoop.hive.ql.exec.ExprNodeEvaluator;
 import org.apache.hadoop.hive.ql.exec.PTFUtils;
+import org.apache.hadoop.hive.ql.plan.Explain;
 import org.apache.hadoop.hive.ql.plan.ExprNodeDesc;
 import org.apache.hadoop.hive.serde2.objectinspector.ObjectInspector;
 
@@ -58,6 +59,11 @@ public void setExprNode(ExprNodeDesc exprNode) {
     this.exprNode = exprNode;
   }
 
+  @Explain(displayName = "expr")
+  public String getExprNodeExplain() {
+    return exprNode == null ? null : exprNode.getExprString();
+  }
+
   public ExprNodeEvaluator getExprEvaluator() {
     return exprEvaluator;
   }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PTFInputDef.java b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PTFInputDef.java
index 19ed2f2..95296c0 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PTFInputDef.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PTFInputDef.java
@@ -19,6 +19,10 @@
 package org.apache.hadoop.hive.ql.plan.ptf;
 
 
+import org.apache.hadoop.hive.ql.exec.RowSchema;
+import org.apache.hadoop.hive.ql.plan.Explain;
+import org.apache.hadoop.util.StringUtils;
+
 public abstract class PTFInputDef {
   private String expressionTreeString;
   private ShapeDetails outputShape;
@@ -36,9 +40,17 @@ public ShapeDetails getOutputShape() {
     return outputShape;
   }
 
+  @Explain(displayName = "output shape")
+  public String getOutputShapeExplain() {
+    RowSchema schema = outputShape.getRr().getRowSchema();
+    return StringUtils.join(", ", schema.getSignature());
+  }
+
   public void setOutputShape(ShapeDetails outputShape) {
     this.outputShape = outputShape;
   }
+
+  @Explain(displayName = "input alias")
   public String getAlias() {
     return alias;
   }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PTFQueryInputDef.java b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PTFQueryInputDef.java
index 11ef932..227b117 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PTFQueryInputDef.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PTFQueryInputDef.java
@@ -19,11 +19,14 @@
 package org.apache.hadoop.hive.ql.plan.ptf;
 
 import org.apache.hadoop.hive.ql.parse.PTFInvocationSpec.PTFQueryInputType;
+import org.apache.hadoop.hive.ql.plan.Explain;
 
+@Explain(displayName = "Input definition")
 public class PTFQueryInputDef extends PTFInputDef {
   private String destination;
   private PTFQueryInputType type;
 
+  @Explain(displayName = "destination")
   public String getDestination() {
     return destination;
   }
@@ -40,6 +43,11 @@ public void setType(PTFQueryInputType type) {
     this.type = type;
   }
 
+  @Explain(displayName = "type")
+  public String getTypeExplain() {
+    return type.name();
+  }
+
   @Override
   public PTFInputDef getInput() {
     return null;
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PartitionedTableFunctionDef.java b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PartitionedTableFunctionDef.java
index 327304c..967caaa 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PartitionedTableFunctionDef.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/PartitionedTableFunctionDef.java
@@ -21,8 +21,11 @@
 import java.util.ArrayList;
 import java.util.List;
 
+import org.apache.hadoop.hive.ql.parse.PTFInvocationSpec;
+import org.apache.hadoop.hive.ql.plan.Explain;
 import org.apache.hadoop.hive.ql.udf.ptf.TableFunctionEvaluator;
 
+@Explain(displayName = "Partition table definition")
 public class PartitionedTableFunctionDef extends PTFInputDef {
   private String name;
   private String resolverClassName;
@@ -35,6 +38,7 @@
   private TableFunctionEvaluator tFunction;
   boolean transformsRawInput;
 
+  @Explain(displayName = "name")
   public String getName() {
     return name;
   }
@@ -47,6 +51,11 @@ public ShapeDetails getRawInputShape() {
     return rawInputShape;
   }
 
+  @Explain(displayName = "raw input shape")
+  public ShapeDetails getRawInputShapeExplain() {
+    return rawInputShape;
+  }
+
   public void setRawInputShape(ShapeDetails rawInputShape) {
     this.rawInputShape = rawInputShape;
   }
@@ -72,6 +81,21 @@ public PartitionDef getPartition() {
     return partition;
   }
 
+  @Explain(displayName = "partition by")
+  public String getPartitionExplain() {
+    if (partition == null || partition.getExpressions() == null) {
+      return null;
+    }
+    StringBuilder builder = new StringBuilder();
+    for (PTFExpressionDef expression : partition.getExpressions()) {
+      if (builder.length() > 0) {
+        builder.append(", ");
+      }
+      builder.append(expression.getExprNode().getExprString());
+    }
+    return builder.toString();
+  }
+
   public void setPartition(PartitionDef partition) {
     this.partition = partition;
   }
@@ -84,9 +108,28 @@ public void setOrder(OrderDef order) {
     this.order = order;
   }
 
+  @Explain(displayName = "order by")
+  public String getOrderExplain() {
+    if (order == null || order.getExpressions() == null) {
+      return null;
+    }
+    StringBuilder builder = new StringBuilder();
+    for (OrderExpressionDef expression : order.getExpressions()) {
+      if (builder.length() > 0) {
+        builder.append(", ");
+      }
+      builder.append(expression.getExprNode().getExprString());
+      if (expression.getOrder() == PTFInvocationSpec.Order.DESC) {
+        builder.append("(DESC)");
+      }
+    }
+    return builder.toString();
+  }
+
   public TableFunctionEvaluator getTFunction() {
     return tFunction;
   }
+
   public void setTFunction(TableFunctionEvaluator tFunction) {
     this.tFunction = tFunction;
   }
@@ -99,6 +142,21 @@ public void setArgs(List<PTFExpressionDef> args) {
     this.args = args;
   }
 
+  @Explain(displayName = "arguments")
+  public String getArgsExplain() {
+    if (args == null) {
+      return null;
+    }
+    StringBuilder builder = new StringBuilder();
+    for (PTFExpressionDef expression : args) {
+      if (builder.length() > 0) {
+        builder.append(", ");
+      }
+      builder.append(expression.getExprNode().getExprString());
+    }
+    return builder.toString();
+  }
+
   public void addArg(PTFExpressionDef arg) {
     args = args == null ? new ArrayList<PTFExpressionDef>() : args;
     args.add(arg);
@@ -111,6 +169,7 @@ public PartitionedTableFunctionDef getStartOfChain() {
     return this;
   }
 
+  @Explain(displayName = "transforms raw input", displayOnlyOnTrue=true)
   public boolean isTransformsRawInput() {
     return transformsRawInput;
   }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/WindowExpressionDef.java b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/WindowExpressionDef.java
index b96e9d6..de18575 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/WindowExpressionDef.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/WindowExpressionDef.java
@@ -19,15 +19,12 @@
 package org.apache.hadoop.hive.ql.plan.ptf;
 
 
-public class WindowExpressionDef extends PTFExpressionDef {
-  private String alias;
-
-  public WindowExpressionDef() {}
+import org.apache.hadoop.hive.ql.plan.Explain;
 
-  public WindowExpressionDef(PTFExpressionDef eDef) {
-    super(eDef);
-  }
+public abstract class WindowExpressionDef extends PTFExpressionDef {
+  private String alias;
 
+  @Explain(displayName = "alias")
   public String getAlias() {
     return alias;
   }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/WindowFunctionDef.java b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/WindowFunctionDef.java
index e4ea358..ed6c671 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/WindowFunctionDef.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/WindowFunctionDef.java
@@ -21,8 +21,10 @@
 import java.util.ArrayList;
 import java.util.List;
 
+import org.apache.hadoop.hive.ql.plan.Explain;
 import org.apache.hadoop.hive.ql.udf.generic.GenericUDAFEvaluator;
 
+@Explain(displayName = "window function definition")
 public class WindowFunctionDef extends WindowExpressionDef {
   String name;
   boolean isStar;
@@ -32,6 +34,7 @@
   GenericUDAFEvaluator wFnEval;
   boolean pivotResult;
 
+  @Explain(displayName = "name")
   public String getName() {
     return name;
   }
@@ -40,6 +43,7 @@ public void setName(String name) {
     this.name = name;
   }
 
+  @Explain(displayName = "isStar", displayOnlyOnTrue = true)
   public boolean isStar() {
     return isStar;
   }
@@ -48,6 +52,7 @@ public void setStar(boolean isStar) {
     this.isStar = isStar;
   }
 
+  @Explain(displayName = "isDistinct", displayOnlyOnTrue = true)
   public boolean isDistinct() {
     return isDistinct;
   }
@@ -69,6 +74,21 @@ public void addArg(PTFExpressionDef arg) {
     args.add(arg);
   }
 
+  @Explain(displayName = "arguments")
+  public String getArgsExplain() {
+    if (args == null) {
+      return null;
+    }
+    StringBuilder builder = new StringBuilder();
+    for (PTFExpressionDef expression : args) {
+      if (builder.length() > 0) {
+        builder.append(", ");
+      }
+      builder.append(expression.getExprNode().getExprString());
+    }
+    return builder.toString();
+  }
+
   public WindowFrameDef getWindowFrame() {
     return windowFrame;
   }
@@ -77,6 +97,11 @@ public void setWindowFrame(WindowFrameDef windowFrame) {
     this.windowFrame = windowFrame;
   }
 
+  @Explain(displayName = "window frame")
+  public String getWindowFrameExplain() {
+    return windowFrame == null ? null : windowFrame.toString();
+  }
+
   public GenericUDAFEvaluator getWFnEval() {
     return wFnEval;
   }
@@ -85,6 +110,12 @@ public void setWFnEval(GenericUDAFEvaluator wFnEval) {
     this.wFnEval = wFnEval;
   }
 
+  @Explain(displayName = "window function")
+  public String getWFnEvalExplain() {
+    return wFnEval == null ? null : wFnEval.getClass().getSimpleName();
+  }
+
+  @Explain(displayName = "isPivotResult", displayOnlyOnTrue = true)
   public boolean isPivotResult() {
     return pivotResult;
   }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/WindowTableFunctionDef.java b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/WindowTableFunctionDef.java
index 083aaf2..97ba17e 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/WindowTableFunctionDef.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/plan/ptf/WindowTableFunctionDef.java
@@ -18,21 +18,26 @@
 
 package org.apache.hadoop.hive.ql.plan.ptf;
 
-import java.util.List;
+import org.apache.hadoop.hive.ql.plan.Explain;
 
+import java.util.List;
 
+@Explain(displayName = "Windowing table definition")
 public class WindowTableFunctionDef extends PartitionedTableFunctionDef {
   List<WindowFunctionDef> windowFunctions;
   
   int rankLimit = -1;
   int rankLimitFunction;
 
+  @Explain(displayName = "window functions")
   public List<WindowFunctionDef> getWindowFunctions() {
     return windowFunctions;
   }
+  
   public void setWindowFunctions(List<WindowFunctionDef> windowFunctions) {
     this.windowFunctions = windowFunctions;
   }
+
   public int getRankLimit() {
     return rankLimit;
   }
diff --git a/ql/src/test/queries/clientpositive/ptf_matchpath.q b/ql/src/test/queries/clientpositive/ptf_matchpath.q
index 80dbe29..6487135 100644
--- a/ql/src/test/queries/clientpositive/ptf_matchpath.q
+++ b/ql/src/test/queries/clientpositive/ptf_matchpath.q
@@ -15,6 +15,17 @@ LOAD DATA LOCAL INPATH '../../data/files/flights_tiny.txt' OVERWRITE INTO TABLE
 -- SORT_QUERY_RESULTS
 
 -- 1. basic Matchpath test
+explain
+select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        distribute by fl_num 
+        sort by year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   );       
+
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
 from matchpath(on 
         flights_tiny 
@@ -26,6 +37,17 @@ from matchpath(on
    );       
 
 -- 2. Matchpath on 1 partition
+explain
+select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        sort by fl_num, year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+where fl_num = 1142;
+
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
 from matchpath(on 
         flights_tiny 
@@ -37,6 +59,17 @@ from matchpath(on
 where fl_num = 1142;
 
 -- 3. empty partition.
+explain
+select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
+from matchpath(on
+        (select * from flights_tiny where fl_num = -1142) flights_tiny
+        sort by fl_num, year, month, day_of_month
+      arg1('LATE.LATE+'),
+      arg2('LATE'), arg3(arr_delay > 15),
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
+   );
+   
+
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
 from matchpath(on
         (select * from flights_tiny where fl_num = -1142) flights_tiny
diff --git a/ql/src/test/results/clientpositive/correlationoptimizer12.q.out b/ql/src/test/results/clientpositive/correlationoptimizer12.q.out
index 3a7247f..159b0c0 100644
--- a/ql/src/test/results/clientpositive/correlationoptimizer12.q.out
+++ b/ql/src/test/results/clientpositive/correlationoptimizer12.q.out
@@ -43,6 +43,24 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col0
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: count
+                        window function: GenericUDAFCountEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
             Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: _col0 is not null (type: boolean)
@@ -114,6 +132,24 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 25 Data size: 191 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col0
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: count
+                        window function: GenericUDAFCountEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
             Statistics: Num rows: 25 Data size: 191 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: _col0 is not null (type: boolean)
diff --git a/ql/src/test/results/clientpositive/ctas_colname.q.out b/ql/src/test/results/clientpositive/ctas_colname.q.out
index 4eb827c..a83af21 100644
--- a/ql/src/test/results/clientpositive/ctas_colname.q.out
+++ b/ql/src/test/results/clientpositive/ctas_colname.q.out
@@ -189,6 +189,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 25 Data size: 191 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 25 Data size: 191 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col0 (type: string), _col1 (type: string), _wcol0 (type: int)
@@ -336,6 +355,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col0, 1
+                        name: lead
+                        window function: GenericUDAFLeadEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col0 (type: string), _col1 (type: string), _wcol0 (type: string)
diff --git a/ql/src/test/results/clientpositive/groupby_grouping_window.q.out b/ql/src/test/results/clientpositive/groupby_grouping_window.q.out
index c0e6e5f..b2434c5 100644
--- a/ql/src/test/results/clientpositive/groupby_grouping_window.q.out
+++ b/ql/src/test/results/clientpositive/groupby_grouping_window.q.out
@@ -93,6 +93,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col2, _col3
           Statistics: Num rows: 1 Data size: 6 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: int, _col2: int, _col3: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col3
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col3
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 1 Data size: 6 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col0 (type: int), _col2 (type: int), _col3 (type: int), _wcol0 (type: int)
diff --git a/ql/src/test/results/clientpositive/groupby_resolution.q.out b/ql/src/test/results/clientpositive/groupby_resolution.q.out
index e5d22a3..c371f5c 100644
--- a/ql/src/test/results/clientpositive/groupby_resolution.q.out
+++ b/ql/src/test/results/clientpositive/groupby_resolution.q.out
@@ -677,6 +677,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 83 Data size: 881 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: bigint
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: 0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 83 Data size: 881 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col0 (type: string), _col1 (type: bigint), _wcol0 (type: int)
diff --git a/ql/src/test/results/clientpositive/ptf.q.out b/ql/src/test/results/clientpositive/ptf.q.out
index 651fa85..278d39a 100644
--- a/ql/src/test/results/clientpositive/ptf.q.out
+++ b/ql/src/test/results/clientpositive/ptf.q.out
@@ -46,6 +46,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -70,6 +82,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -216,6 +260,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: j
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: SUBQUERY
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -240,6 +296,25 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col5, 1, _col5
+                        name: lag
+                        window function: GenericUDAFLagEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), (_col5 - _wcol0) (type: int)
@@ -338,6 +413,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -441,6 +528,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: abc
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -465,6 +564,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -576,6 +707,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -600,6 +743,39 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5, 1, _col5
+                        name: lag
+                        window function: GenericUDAFLagEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), (_col5 - _wcol2) (type: int)
@@ -714,6 +890,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -769,6 +957,39 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1, _col2
           Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string, _col2: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col2, 1, _col2
+                        name: lag
+                        window function: GenericUDAFLagEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col0 (type: string), _col1 (type: string), _col2 (type: int), _wcol0 (type: int), _wcol1 (type: int), _col2 (type: int), (_col2 - _wcol2) (type: int)
@@ -875,6 +1096,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                  type: TABLE
+                Partition table definition
+                  input alias: abc
+                  name: noop
+                  order by: _col1
+                  output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: _col0 is not null (type: boolean)
@@ -1012,6 +1245,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                  type: TABLE
+                Partition table definition
+                  input alias: abc
+                  name: noop
+                  order by: _col1
+                  output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: _col0 is not null (type: boolean)
@@ -1144,7 +1389,21 @@ STAGE PLANS:
             alias: part
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: part
+                    output shape: p_name: string, p_mfgr: string, p_size: int
+                    type: TABLE
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: p_name, p_size(DESC)
+                    output shape: p_name: string, p_mfgr: string, p_size: int
+                    partition by: p_mfgr
+                    raw input shape:
+                    transforms raw input: true
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               Reduce Output Operator
                 key expressions: p_mfgr (type: string), p_name (type: string), p_size (type: int)
                 sort order: ++-
@@ -1155,6 +1414,19 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col1, _col5(DESC)
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1178,6 +1450,25 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1, _col5(DESC)
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1, _col5
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int)
@@ -1272,7 +1563,21 @@ STAGE PLANS:
             alias: part
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: part
+                    output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                    type: TABLE
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: p_name
+                    output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                    partition by: p_mfgr
+                    raw input shape:
+                    transforms raw input: true
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               Reduce Output Operator
                 key expressions: p_mfgr (type: string), p_name (type: string)
                 sort order: ++
@@ -1283,6 +1588,19 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1307,6 +1625,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1414,6 +1764,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1438,6 +1800,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1548,9 +1942,42 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    partition by: _col2
+                    raw input shape:
+                    transforms raw input: true
+                  Partition table definition
+                    input alias: ptf_2
+                    name: noop
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    partition by: _col2
+                    raw input shape:
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 table:
@@ -1572,6 +1999,26 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1596,6 +2043,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1713,6 +2192,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1737,6 +2228,30 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col5
+                        name: count
+                        window function: GenericUDAFCountEvaluator
+                        window frame: PRECEDING(MAX)~
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(2)~FOLLOWING(2)
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: bigint), _wcol1 (type: double)
@@ -1859,6 +2374,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: abc
+                  name: noop
+                  order by: _col1
+                  output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: _col0 is not null (type: boolean)
@@ -1923,6 +2450,51 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col1
+                        name: count
+                        window function: GenericUDAFCountEvaluator
+                        window frame: PRECEDING(MAX)~
+                      window function definition
+                        alias: _wcol3
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
+                      window function definition
+                        alias: _wcol4
+                        arguments: _col5, 1, _col5
+                        name: lag
+                        window function: GenericUDAFLagEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: bigint), _col7 (type: double), _wcol3 (type: double), _col5 (type: int), (_col5 - _wcol4) (type: int)
@@ -2032,6 +2604,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -2210,6 +2794,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: mfgr_price_view
+                  output shape: _col0: string, _col1: string, _col2: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col0
+                  output shape: _col0: string, _col1: string, _col2: double
+                  partition by: _col0
+                  raw input shape:
             Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -2234,6 +2830,24 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1, _col2
           Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string, _col2: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(2)~
             Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col0 (type: string), _col1 (type: string), _col2 (type: double), _wcol0 (type: double)
@@ -2394,6 +3008,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -2424,6 +3050,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -2467,6 +3125,24 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col5
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(5)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col1 (type: string), _col2 (type: string), _col5 (type: int), _wcol0 (type: bigint)
@@ -2495,6 +3171,45 @@ STAGE PLANS:
           outputColumnNames: _col0, _col2, _col3, _col6
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: bigint, _col2: string, _col3: string, _col6: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col3, _col2
+                  partition by: _col3
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col3, _col2
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col3, _col2
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol3
+                        arguments: _col3, _col2
+                        name: cume_dist
+                        window function: GenericUDAFCumeDistEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol4
+                        arguments: _col6, true
+                        name: first_value
+                        window function: GenericUDAFFirstValueEvaluator
+                        window frame: PRECEDING(2)~FOLLOWING(2)
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col3 (type: string), _col2 (type: string), _col6 (type: int), UDFToInteger(round(_col0, 1)) (type: int), _wcol1 (type: int), _wcol2 (type: int), _wcol3 (type: double), _wcol4 (type: int)
@@ -2699,9 +3414,49 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2, _col1
+                    raw input shape:
+                    transforms raw input: true
+                  Partition table definition
+                    input alias: ptf_2
+                    name: noop
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2, _col1
+                    raw input shape:
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 table:
@@ -2723,6 +3478,26 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                  transforms raw input: true
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -2747,6 +3522,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col2, _col1
+                  partition by: _col2, _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2, _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col2, _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -2888,6 +3695,25 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -2910,6 +3736,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -2932,6 +3770,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -2956,6 +3806,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -3092,6 +3974,25 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -3114,6 +4015,25 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -3138,6 +4058,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -3275,6 +4227,25 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -3297,9 +4268,35 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2, _col1
+                    raw input shape:
+                    transforms raw input: true
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 table:
@@ -3321,6 +4318,19 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                  transforms raw input: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -3345,6 +4355,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col2, _col1
+                  partition by: _col2, _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2, _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col2, _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -3483,9 +4525,42 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: _col2
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2
+                    raw input shape:
+                    transforms raw input: true
+                  Partition table definition
+                    input alias: ptf_2
+                    name: noop
+                    order by: _col2
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2
+                    raw input shape:
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 table:
@@ -3507,6 +4582,26 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -3531,6 +4626,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col2, _col1
+                  partition by: _col2, _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2, _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col2, _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
@@ -3663,9 +4790,42 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2, _col1
+                    raw input shape:
+                    transforms raw input: true
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 table:
@@ -3687,6 +4847,19 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                  transforms raw input: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -3711,6 +4884,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
diff --git a/ql/src/test/results/clientpositive/ptf_matchpath.q.out b/ql/src/test/results/clientpositive/ptf_matchpath.q.out
index e0cea0d..b9df26b 100644
--- a/ql/src/test/results/clientpositive/ptf_matchpath.q.out
+++ b/ql/src/test/results/clientpositive/ptf_matchpath.q.out
@@ -37,6 +37,7 @@ POSTHOOK: Output: default@flights_tiny
 PREHOOK: query: -- SORT_QUERY_RESULTS
 
 -- 1. basic Matchpath test
+explain
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
 from matchpath(on 
         flights_tiny 
@@ -47,11 +48,10 @@ from matchpath(on
     arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
    )
 PREHOOK: type: QUERY
-PREHOOK: Input: default@flights_tiny
-#### A masked pattern was here ####
 POSTHOOK: query: -- SORT_QUERY_RESULTS
 
 -- 1. basic Matchpath test
+explain
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
 from matchpath(on 
         flights_tiny 
@@ -62,6 +62,81 @@ from matchpath(on
     arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
    )
 POSTHOOK: type: QUERY
+STAGE DEPENDENCIES:
+  Stage-1 is a root stage
+  Stage-0 depends on stages: Stage-1
+
+STAGE PLANS:
+  Stage: Stage-1
+    Map Reduce
+      Map Operator Tree:
+          TableScan
+            alias: flights_tiny
+            Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+            Reduce Output Operator
+              key expressions: fl_num (type: string), year (type: int), month (type: int), day_of_month (type: int)
+              sort order: ++++
+              Map-reduce partition columns: fl_num (type: string)
+              Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+              value expressions: origin_city_name (type: string), dest_city_name (type: string), year (type: int), month (type: int), day_of_month (type: int), arr_delay (type: float), fl_num (type: string), BLOCK__OFFSET__INSIDE__FILE (type: bigint), INPUT__FILE__NAME (type: string), ROW__ID (type: struct<transactionid:bigint,bucketid:int,rowid:bigint>)
+      Reduce Operator Tree:
+        Extract
+          Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+          PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: flights_tiny
+                  output shape: _col0: string, _col1: string, _col2: int, _col3: int, _col4: int, _col5: float, _col6: string, _col7: bigint, _col8: string, _col9: struct<transactionid:bigint,bucketid:int,rowid:bigint>
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  arguments: 'LATE.LATE+', 'LATE', (_col5 > 15.0), 'origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath'
+                  name: matchpath
+                  order by: _col2, _col3, _col4
+                  output shape: origin_city_name: string, fl_num: string, year: int, month: int, day_of_month: int, sz: int, tpath: int
+                  partition by: _col6
+                  raw input shape:
+            Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+            Select Operator
+              expressions: origin_city_name (type: string), fl_num (type: string), year (type: int), month (type: int), day_of_month (type: int), sz (type: int), tpath (type: int)
+              outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6
+              Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+              File Output Operator
+                compressed: false
+                Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                table:
+                    input format: org.apache.hadoop.mapred.TextInputFormat
+                    output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
+                    serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
+
+  Stage: Stage-0
+    Fetch Operator
+      limit: -1
+      Processor Tree:
+        ListSink
+
+PREHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        distribute by fl_num 
+        sort by year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+PREHOOK: type: QUERY
+PREHOOK: Input: default@flights_tiny
+#### A masked pattern was here ####
+POSTHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        distribute by fl_num 
+        sort by year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+POSTHOOK: type: QUERY
 POSTHOOK: Input: default@flights_tiny
 #### A masked pattern was here ####
 Baltimore	1142	2010	10	20	6	20
@@ -81,6 +156,7 @@ Chicago	897	2010	10	21	3	21
 Chicago	897	2010	10	22	2	22
 Washington	7291	2010	10	27	2	27
 PREHOOK: query: -- 2. Matchpath on 1 partition
+explain
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
 from matchpath(on 
         flights_tiny 
@@ -91,9 +167,8 @@ from matchpath(on
    )
 where fl_num = 1142
 PREHOOK: type: QUERY
-PREHOOK: Input: default@flights_tiny
-#### A masked pattern was here ####
 POSTHOOK: query: -- 2. Matchpath on 1 partition
+explain
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
 from matchpath(on 
         flights_tiny 
@@ -104,6 +179,84 @@ from matchpath(on
    )
 where fl_num = 1142
 POSTHOOK: type: QUERY
+STAGE DEPENDENCIES:
+  Stage-1 is a root stage
+  Stage-0 depends on stages: Stage-1
+
+STAGE PLANS:
+  Stage: Stage-1
+    Map Reduce
+      Map Operator Tree:
+          TableScan
+            alias: flights_tiny
+            Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+            Reduce Output Operator
+              key expressions: 0 (type: int), fl_num (type: string), year (type: int), month (type: int), day_of_month (type: int)
+              sort order: +++++
+              Map-reduce partition columns: 0 (type: int)
+              Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+              value expressions: origin_city_name (type: string), dest_city_name (type: string), year (type: int), month (type: int), day_of_month (type: int), arr_delay (type: float), fl_num (type: string), BLOCK__OFFSET__INSIDE__FILE (type: bigint), INPUT__FILE__NAME (type: string), ROW__ID (type: struct<transactionid:bigint,bucketid:int,rowid:bigint>)
+      Reduce Operator Tree:
+        Extract
+          Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+          PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: flights_tiny
+                  output shape: _col0: string, _col1: string, _col2: int, _col3: int, _col4: int, _col5: float, _col6: string, _col7: bigint, _col8: string, _col9: struct<transactionid:bigint,bucketid:int,rowid:bigint>
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  arguments: 'LATE.LATE+', 'LATE', (_col5 > 15.0), 'origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath'
+                  name: matchpath
+                  order by: _col6, _col2, _col3, _col4
+                  output shape: origin_city_name: string, fl_num: string, year: int, month: int, day_of_month: int, sz: int, tpath: int
+                  partition by: 0
+                  raw input shape:
+            Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+            Filter Operator
+              predicate: (fl_num = 1142) (type: boolean)
+              Statistics: Num rows: 8 Data size: 2531 Basic stats: COMPLETE Column stats: NONE
+              Select Operator
+                expressions: origin_city_name (type: string), '1142' (type: string), year (type: int), month (type: int), day_of_month (type: int), sz (type: int), tpath (type: int)
+                outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6
+                Statistics: Num rows: 8 Data size: 2531 Basic stats: COMPLETE Column stats: NONE
+                File Output Operator
+                  compressed: false
+                  Statistics: Num rows: 8 Data size: 2531 Basic stats: COMPLETE Column stats: NONE
+                  table:
+                      input format: org.apache.hadoop.mapred.TextInputFormat
+                      output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
+                      serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
+
+  Stage: Stage-0
+    Fetch Operator
+      limit: -1
+      Processor Tree:
+        ListSink
+
+PREHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        sort by fl_num, year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+where fl_num = 1142
+PREHOOK: type: QUERY
+PREHOOK: Input: default@flights_tiny
+#### A masked pattern was here ####
+POSTHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        sort by fl_num, year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+where fl_num = 1142
+POSTHOOK: type: QUERY
 POSTHOOK: Input: default@flights_tiny
 #### A masked pattern was here ####
 Baltimore	1142	2010	10	20	6	20
@@ -112,6 +265,7 @@ Baltimore	1142	2010	10	22	4	22
 Baltimore	1142	2010	10	25	3	25
 Baltimore	1142	2010	10	26	2	26
 PREHOOK: query: -- 3. empty partition.
+explain
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
 from matchpath(on
         (select * from flights_tiny where fl_num = -1142) flights_tiny
@@ -121,9 +275,8 @@ from matchpath(on
     arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
    )
 PREHOOK: type: QUERY
-PREHOOK: Input: default@flights_tiny
-#### A masked pattern was here ####
 POSTHOOK: query: -- 3. empty partition.
+explain
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
 from matchpath(on
         (select * from flights_tiny where fl_num = -1142) flights_tiny
@@ -133,5 +286,85 @@ from matchpath(on
     arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
    )
 POSTHOOK: type: QUERY
+STAGE DEPENDENCIES:
+  Stage-1 is a root stage
+  Stage-0 depends on stages: Stage-1
+
+STAGE PLANS:
+  Stage: Stage-1
+    Map Reduce
+      Map Operator Tree:
+          TableScan
+            alias: flights_tiny
+            Statistics: Num rows: 24 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+            Filter Operator
+              predicate: (fl_num = -1142) (type: boolean)
+              Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+              Select Operator
+                expressions: origin_city_name (type: string), dest_city_name (type: string), year (type: int), month (type: int), day_of_month (type: int), arr_delay (type: float)
+                outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5
+                Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                Reduce Output Operator
+                  key expressions: 0 (type: int), '-1142' (type: string), _col2 (type: int), _col3 (type: int), _col4 (type: int)
+                  sort order: +++++
+                  Map-reduce partition columns: 0 (type: int)
+                  Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                  value expressions: _col0 (type: string), _col1 (type: string), _col2 (type: int), _col3 (type: int), _col4 (type: int), _col5 (type: float), '-1142' (type: string)
+      Reduce Operator Tree:
+        Extract
+          Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+          PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: flights_tiny
+                  output shape: _col0: string, _col1: string, _col2: int, _col3: int, _col4: int, _col5: float, _col6: string
+                  type: SUBQUERY
+                Partition table definition
+                  input alias: ptf_1
+                  arguments: 'LATE.LATE+', 'LATE', (_col5 > 15.0), 'origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath'
+                  name: matchpath
+                  order by: _col6, _col2, _col3, _col4
+                  output shape: origin_city_name: string, fl_num: string, year: int, month: int, day_of_month: int, sz: int, tpath: int
+                  partition by: 0
+                  raw input shape:
+            Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+            Select Operator
+              expressions: origin_city_name (type: string), '-1142' (type: string), year (type: int), month (type: int), day_of_month (type: int), sz (type: int), tpath (type: int)
+              outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6
+              Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+              File Output Operator
+                compressed: false
+                Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                table:
+                    input format: org.apache.hadoop.mapred.TextInputFormat
+                    output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
+                    serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
+
+  Stage: Stage-0
+    Fetch Operator
+      limit: -1
+      Processor Tree:
+        ListSink
+
+PREHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
+from matchpath(on
+        (select * from flights_tiny where fl_num = -1142) flights_tiny
+        sort by fl_num, year, month, day_of_month
+      arg1('LATE.LATE+'),
+      arg2('LATE'), arg3(arr_delay > 15),
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
+   )
+PREHOOK: type: QUERY
+PREHOOK: Input: default@flights_tiny
+#### A masked pattern was here ####
+POSTHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
+from matchpath(on
+        (select * from flights_tiny where fl_num = -1142) flights_tiny
+        sort by fl_num, year, month, day_of_month
+      arg1('LATE.LATE+'),
+      arg2('LATE'), arg3(arr_delay > 15),
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
+   )
+POSTHOOK: type: QUERY
 POSTHOOK: Input: default@flights_tiny
 #### A masked pattern was here ####
diff --git a/ql/src/test/results/clientpositive/ptf_streaming.q.out b/ql/src/test/results/clientpositive/ptf_streaming.q.out
index 427e635..bec8e43 100644
--- a/ql/src/test/results/clientpositive/ptf_streaming.q.out
+++ b/ql/src/test/results/clientpositive/ptf_streaming.q.out
@@ -46,6 +46,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopstreaming
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -70,6 +82,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -216,6 +260,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: j
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: SUBQUERY
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopstreaming
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -240,6 +296,25 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col5, 1, _col5
+                        name: lag
+                        window function: GenericUDAFLagEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), (_col5 - _wcol0) (type: int)
@@ -341,6 +416,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                  type: TABLE
+                Partition table definition
+                  input alias: abc
+                  name: noopstreaming
+                  order by: _col1
+                  output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: _col0 is not null (type: boolean)
@@ -469,7 +556,21 @@ STAGE PLANS:
             alias: part
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: part
+                    output shape: p_name: string, p_mfgr: string, p_size: int
+                    type: TABLE
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmapstreaming
+                    order by: p_name, p_size(DESC)
+                    output shape: p_name: string, p_mfgr: string, p_size: int
+                    partition by: p_mfgr
+                    raw input shape:
+                    transforms raw input: true
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               Reduce Output Operator
                 key expressions: p_mfgr (type: string), p_name (type: string), p_size (type: int)
                 sort order: ++-
@@ -480,6 +581,19 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmapstreaming
+                  order by: _col1, _col5(DESC)
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -503,6 +617,25 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1, _col5(DESC)
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1, _col5
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int)
@@ -597,7 +730,21 @@ STAGE PLANS:
             alias: part
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: part
+                    output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                    type: TABLE
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmapstreaming
+                    order by: p_name
+                    output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                    partition by: p_mfgr
+                    raw input shape:
+                    transforms raw input: true
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               Reduce Output Operator
                 key expressions: p_mfgr (type: string), p_name (type: string)
                 sort order: ++
@@ -608,6 +755,19 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmapstreaming
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -632,6 +792,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -742,9 +934,42 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopstreaming
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmapstreaming
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    partition by: _col2
+                    raw input shape:
+                    transforms raw input: true
+                  Partition table definition
+                    input alias: ptf_2
+                    name: noopstreaming
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    partition by: _col2
+                    raw input shape:
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 table:
@@ -766,6 +991,26 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmapstreaming
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
+                Partition table definition
+                  input alias: ptf_2
+                  name: noopstreaming
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -790,6 +1035,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -902,9 +1179,42 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopstreaming
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    partition by: _col2
+                    raw input shape:
+                    transforms raw input: true
+                  Partition table definition
+                    input alias: ptf_2
+                    name: noopstreaming
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    partition by: _col2
+                    raw input shape:
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 table:
@@ -926,6 +1236,26 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
+                Partition table definition
+                  input alias: ptf_2
+                  name: noopstreaming
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -950,6 +1280,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1062,9 +1424,42 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopstreaming
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmapstreaming
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    partition by: _col2
+                    raw input shape:
+                    transforms raw input: true
+                  Partition table definition
+                    input alias: ptf_2
+                    name: noop
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    partition by: _col2
+                    raw input shape:
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 table:
@@ -1086,6 +1481,26 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmapstreaming
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1110,6 +1525,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1226,6 +1673,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: abc
+                  name: noopstreaming
+                  order by: _col1
+                  output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: _col0 is not null (type: boolean)
@@ -1290,6 +1749,51 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col1
+                        name: count
+                        window function: GenericUDAFCountEvaluator
+                        window frame: PRECEDING(MAX)~
+                      window function definition
+                        alias: _wcol3
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
+                      window function definition
+                        alias: _wcol4
+                        arguments: _col5, 1, _col5
+                        name: lag
+                        window function: GenericUDAFLagEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: bigint), _col7 (type: double), _wcol3 (type: double), _col5 (type: int), (_col5 - _wcol4) (type: int)
@@ -1422,9 +1926,49 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopstreaming
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2, _col1
+                    raw input shape:
+                    transforms raw input: true
+                  Partition table definition
+                    input alias: ptf_2
+                    name: noopstreaming
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2, _col1
+                    raw input shape:
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 table:
@@ -1446,6 +1990,26 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                  transforms raw input: true
+                Partition table definition
+                  input alias: ptf_2
+                  name: noopstreaming
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1470,6 +2034,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col2, _col1
+                  partition by: _col2, _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2, _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col2, _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -1611,6 +2207,25 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopstreaming
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1633,6 +2248,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopstreaming
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1655,6 +2282,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1679,6 +2318,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -1813,9 +2484,42 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopstreaming
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmapstreaming
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2, _col1
+                    raw input shape:
+                    transforms raw input: true
               Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 table:
@@ -1837,6 +2541,19 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmapstreaming
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                  transforms raw input: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1861,6 +2578,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
diff --git a/ql/src/test/results/clientpositive/ptfgroupbyjoin.q.out b/ql/src/test/results/clientpositive/ptfgroupbyjoin.q.out
index df72d82..daa9de2 100644
--- a/ql/src/test/results/clientpositive/ptfgroupbyjoin.q.out
+++ b/ql/src/test/results/clientpositive/ptfgroupbyjoin.q.out
@@ -119,6 +119,24 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 1 Data size: 9 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: int, _col1: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col0, _col1
+                  partition by: _col0, _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        name: row_number
+                        window function: GenericUDAFRowNumberEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 1 Data size: 9 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: _col1 is not null (type: boolean)
@@ -280,6 +298,24 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 1 Data size: 9 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: int, _col1: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col0, _col1
+                  partition by: _col0, _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        name: row_number
+                        window function: GenericUDAFRowNumberEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 1 Data size: 9 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: _col1 is not null (type: boolean)
@@ -441,6 +477,24 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 1 Data size: 9 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: int, _col1: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col0, _col1
+                  partition by: _col0, _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        name: row_number
+                        window function: GenericUDAFRowNumberEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 1 Data size: 9 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col0 (type: int), _col1 (type: int)
diff --git a/ql/src/test/results/clientpositive/quotedid_basic.q.out b/ql/src/test/results/clientpositive/quotedid_basic.q.out
index 1788d08..214534a 100644
--- a/ql/src/test/results/clientpositive/quotedid_basic.q.out
+++ b/ql/src/test/results/clientpositive/quotedid_basic.q.out
@@ -198,6 +198,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1, _col2
           Statistics: Num rows: 1 Data size: 0 Basic stats: PARTIAL Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string, _col2: string
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 1 Data size: 0 Basic stats: PARTIAL Column stats: NONE
             Select Operator
               expressions: _col0 (type: string), _col1 (type: string), _col2 (type: string), _wcol0 (type: int)
@@ -283,6 +302,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1, _col2
           Statistics: Num rows: 1 Data size: 0 Basic stats: PARTIAL Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string, _col2: string
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 1 Data size: 0 Basic stats: PARTIAL Column stats: NONE
             Select Operator
               expressions: _col0 (type: string), _col1 (type: string), _col2 (type: string), _wcol0 (type: int)
diff --git a/ql/src/test/results/clientpositive/sample10.q.out b/ql/src/test/results/clientpositive/sample10.q.out
index 6495fb8..a6bc91a 100644
--- a/ql/src/test/results/clientpositive/sample10.q.out
+++ b/ql/src/test/results/clientpositive/sample10.q.out
@@ -97,6 +97,7 @@ STAGE PLANS:
             Filter Operator
               isSamplingPred: true
               predicate: (((hash(key) & 2147483647) % 4) = 0) (type: boolean)
+              sampleDesc: BUCKET 1 OUT OF 4
               Statistics: Num rows: 20 Data size: 120 Basic stats: COMPLETE Column stats: NONE
               Select Operator
                 expressions: ds (type: string)
diff --git a/ql/src/test/results/clientpositive/sample2.q.out b/ql/src/test/results/clientpositive/sample2.q.out
index 5b6b0f5..b8e0686 100644
--- a/ql/src/test/results/clientpositive/sample2.q.out
+++ b/ql/src/test/results/clientpositive/sample2.q.out
@@ -62,6 +62,7 @@ STAGE PLANS:
             Filter Operator
               isSamplingPred: true
               predicate: (((hash(key) & 2147483647) % 2) = 0) (type: boolean)
+              sampleDesc: BUCKET 1 OUT OF 2
               Statistics: Num rows: 500 Data size: 5301 Basic stats: COMPLETE Column stats: NONE
               Select Operator
                 expressions: key (type: int), value (type: string)
diff --git a/ql/src/test/results/clientpositive/sample4.q.out b/ql/src/test/results/clientpositive/sample4.q.out
index b39cc2c..e1bc757 100644
--- a/ql/src/test/results/clientpositive/sample4.q.out
+++ b/ql/src/test/results/clientpositive/sample4.q.out
@@ -64,6 +64,7 @@ STAGE PLANS:
             Filter Operator
               isSamplingPred: true
               predicate: (((hash(key) & 2147483647) % 2) = 0) (type: boolean)
+              sampleDesc: BUCKET 1 OUT OF 2
               Statistics: Num rows: 500 Data size: 5301 Basic stats: COMPLETE Column stats: NONE
               Select Operator
                 expressions: key (type: int), value (type: string)
diff --git a/ql/src/test/results/clientpositive/sample6.q.out b/ql/src/test/results/clientpositive/sample6.q.out
index 9241ce0..0fb239b 100644
--- a/ql/src/test/results/clientpositive/sample6.q.out
+++ b/ql/src/test/results/clientpositive/sample6.q.out
@@ -62,6 +62,7 @@ STAGE PLANS:
             Filter Operator
               isSamplingPred: true
               predicate: (((hash(key) & 2147483647) % 4) = 0) (type: boolean)
+              sampleDesc: BUCKET 1 OUT OF 4
               Statistics: Num rows: 500 Data size: 5301 Basic stats: COMPLETE Column stats: NONE
               Select Operator
                 expressions: key (type: int), value (type: string)
@@ -645,6 +646,7 @@ STAGE PLANS:
             Filter Operator
               isSamplingPred: true
               predicate: (((hash(key) & 2147483647) % 4) = 3) (type: boolean)
+              sampleDesc: BUCKET 4 OUT OF 4
               Statistics: Num rows: 500 Data size: 5301 Basic stats: COMPLETE Column stats: NONE
               Select Operator
                 expressions: key (type: int), value (type: string)
@@ -1042,6 +1044,7 @@ STAGE PLANS:
             Filter Operator
               isSamplingPred: true
               predicate: (((hash(key) & 2147483647) % 2) = 0) (type: boolean)
+              sampleDesc: BUCKET 1 OUT OF 2
               Statistics: Num rows: 500 Data size: 5301 Basic stats: COMPLETE Column stats: NONE
               Select Operator
                 expressions: key (type: int), value (type: string)
@@ -2667,6 +2670,7 @@ STAGE PLANS:
             Filter Operator
               isSamplingPred: true
               predicate: (((hash(key) & 2147483647) % 2) = 0) (type: boolean)
+              sampleDesc: BUCKET 1 OUT OF 2
               Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
               Select Operator
                 expressions: key (type: int), value (type: string)
@@ -2994,6 +2998,7 @@ STAGE PLANS:
             Filter Operator
               isSamplingPred: true
               predicate: (((hash(key) & 2147483647) % 4) = 1) (type: boolean)
+              sampleDesc: BUCKET 2 OUT OF 4
               Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
               Select Operator
                 expressions: key (type: int), value (type: string)
diff --git a/ql/src/test/results/clientpositive/sample9.q.out b/ql/src/test/results/clientpositive/sample9.q.out
index a8c2e82..b5e625f 100644
--- a/ql/src/test/results/clientpositive/sample9.q.out
+++ b/ql/src/test/results/clientpositive/sample9.q.out
@@ -58,6 +58,7 @@ STAGE PLANS:
             Filter Operator
               isSamplingPred: true
               predicate: (((hash(key) & 2147483647) % 2) = 0) (type: boolean)
+              sampleDesc: BUCKET 1 OUT OF 2
               Statistics: Num rows: 500 Data size: 5301 Basic stats: COMPLETE Column stats: NONE
               Select Operator
                 expressions: key (type: int), value (type: string)
diff --git a/ql/src/test/results/clientpositive/smb_mapjoin_11.q.out b/ql/src/test/results/clientpositive/smb_mapjoin_11.q.out
index 056c9f1..691cb46 100644
--- a/ql/src/test/results/clientpositive/smb_mapjoin_11.q.out
+++ b/ql/src/test/results/clientpositive/smb_mapjoin_11.q.out
@@ -1863,6 +1863,7 @@ STAGE PLANS:
             Filter Operator
               isSamplingPred: true
               predicate: (((hash(key) & 2147483647) % 16) = 1) (type: boolean)
+              sampleDesc: BUCKET 2 OUT OF 16
               Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
               Select Operator
                 expressions: key (type: int), value (type: string), ds (type: string)
@@ -1987,6 +1988,7 @@ STAGE PLANS:
             Filter Operator
               isSamplingPred: true
               predicate: (((hash(key) & 2147483647) % 16) = 1) (type: boolean)
+              sampleDesc: BUCKET 2 OUT OF 16
               Statistics: Num rows: 514 Data size: 5484 Basic stats: COMPLETE Column stats: NONE
               Select Operator
                 expressions: key (type: int), value (type: string), ds (type: string)
diff --git a/ql/src/test/results/clientpositive/spark/groupby_resolution.q.out b/ql/src/test/results/clientpositive/spark/groupby_resolution.q.out
index d9c4dc8..4400e1c 100644
--- a/ql/src/test/results/clientpositive/spark/groupby_resolution.q.out
+++ b/ql/src/test/results/clientpositive/spark/groupby_resolution.q.out
@@ -667,6 +667,25 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col1
                 Statistics: Num rows: 83 Data size: 881 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: string, _col1: bigint
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: 0
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 83 Data size: 881 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col0 (type: string), _col1 (type: bigint), _wcol0 (type: int)
diff --git a/ql/src/test/results/clientpositive/spark/ptf.q.out b/ql/src/test/results/clientpositive/spark/ptf.q.out
index 84715b4..a5bcdfa 100644
--- a/ql/src/test/results/clientpositive/spark/ptf.q.out
+++ b/ql/src/test/results/clientpositive/spark/ptf.q.out
@@ -52,6 +52,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -66,6 +78,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -210,6 +254,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: j
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: SUBQUERY
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -224,6 +280,25 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), (_col5 - _wcol0) (type: int)
@@ -328,6 +403,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -437,6 +524,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -451,6 +550,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -568,6 +699,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -582,6 +725,39 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), (_col5 - _wcol2) (type: int)
@@ -702,6 +878,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -737,6 +925,39 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col1, _col2
                 Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: string, _col1: string, _col2: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col0
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col2, 1, _col2
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col0 (type: string), _col1 (type: string), _col2 (type: int), _wcol0 (type: int), _wcol1 (type: int), _col2 (type: int), (_col2 - _wcol2) (type: int)
@@ -862,6 +1083,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: _col0 is not null (type: boolean)
@@ -1018,6 +1251,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: _col0 is not null (type: boolean)
@@ -1113,7 +1358,21 @@ STAGE PLANS:
                   alias: part
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: part
+                          output shape: p_name: string, p_mfgr: string, p_size: int
+                          type: TABLE
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: p_name, p_size(DESC)
+                          output shape: p_name: string, p_mfgr: string, p_size: int
+                          partition by: p_mfgr
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: p_mfgr (type: string), p_name (type: string), p_size (type: int)
                       sort order: ++-
@@ -1125,6 +1384,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col1, _col5(DESC)
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -1138,6 +1410,25 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1, _col5(DESC)
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1, _col5
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int)
@@ -1237,7 +1528,21 @@ STAGE PLANS:
                   alias: part
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: part
+                          output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                          type: TABLE
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: p_name
+                          output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                          partition by: p_mfgr
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: p_mfgr (type: string), p_name (type: string)
                       sort order: ++
@@ -1249,6 +1554,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1263,6 +1581,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1376,6 +1726,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1390,6 +1752,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1506,9 +1900,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: +++
@@ -1520,6 +1947,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1534,6 +1981,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1657,6 +2136,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1671,6 +2162,30 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5
+                              name: count
+                              window function: GenericUDAFCountEvaluator
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(2)~FOLLOWING(2)
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: bigint), _wcol1 (type: double)
@@ -1812,6 +2327,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: _col0 is not null (type: boolean)
@@ -1845,6 +2372,51 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col1
+                              name: count
+                              window function: GenericUDAFCountEvaluator
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol3
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol4
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: bigint), _col7 (type: double), _wcol3 (type: double), _col5 (type: int), (_col5 - _wcol4) (type: int)
@@ -1960,6 +2532,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -2124,6 +2708,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: mfgr_price_view
+                        output shape: _col0: string, _col1: string, _col2: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col0
+                        output shape: _col0: string, _col1: string, _col2: double
+                        partition by: _col0
+                        raw input shape:
                   Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col0 (type: string), _col1 (type: string)
@@ -2138,6 +2734,24 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col1, _col2
                 Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: string, _col1: string, _col2: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col0
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(2)~
                   Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col0 (type: string), _col1 (type: string), _col2 (type: double), _wcol0 (type: double)
@@ -2307,6 +2921,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -2327,6 +2973,24 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col5
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(5)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col1 (type: string), _col2 (type: string), _col5 (type: int), _wcol0 (type: bigint)
@@ -2345,6 +3009,45 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col2, _col3, _col6
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: bigint, _col2: string, _col3: string, _col6: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col3, _col2
+                        partition by: _col3
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col3, _col2
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col3, _col2
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol3
+                              arguments: _col3, _col2
+                              name: cume_dist
+                              window function: GenericUDAFCumeDistEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol4
+                              arguments: _col6, true
+                              name: first_value
+                              window function: GenericUDAFFirstValueEvaluator
+                              window frame: PRECEDING(2)~FOLLOWING(2)
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col3 (type: string), _col2 (type: string), _col6 (type: int), UDFToInteger(round(_col0, 1)) (type: int), _wcol1 (type: int), _wcol2 (type: int), _wcol3 (type: double), _wcol4 (type: int)
@@ -2363,6 +3066,16 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -2375,6 +3088,16 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col5 (type: int)
@@ -2592,9 +3315,49 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -2606,6 +3369,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -2620,6 +3403,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -2767,6 +3582,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -2779,6 +3613,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -2791,6 +3637,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -2805,6 +3663,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -2947,6 +3837,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -2959,6 +3868,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -2973,6 +3901,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -3116,6 +4076,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -3128,9 +4107,35 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -3142,6 +4147,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -3156,6 +4174,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -3300,9 +4350,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string)
                       sort order: ++
@@ -3314,6 +4397,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -3328,6 +4431,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
@@ -3466,9 +4601,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -3480,6 +4648,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -3494,6 +4675,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
diff --git a/ql/src/test/results/clientpositive/spark/ptf_matchpath.q.out b/ql/src/test/results/clientpositive/spark/ptf_matchpath.q.out
index e0cea0d..3ff370c 100644
--- a/ql/src/test/results/clientpositive/spark/ptf_matchpath.q.out
+++ b/ql/src/test/results/clientpositive/spark/ptf_matchpath.q.out
@@ -37,6 +37,7 @@ POSTHOOK: Output: default@flights_tiny
 PREHOOK: query: -- SORT_QUERY_RESULTS
 
 -- 1. basic Matchpath test
+explain
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
 from matchpath(on 
         flights_tiny 
@@ -47,11 +48,10 @@ from matchpath(on
     arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
    )
 PREHOOK: type: QUERY
-PREHOOK: Input: default@flights_tiny
-#### A masked pattern was here ####
 POSTHOOK: query: -- SORT_QUERY_RESULTS
 
 -- 1. basic Matchpath test
+explain
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
 from matchpath(on 
         flights_tiny 
@@ -62,6 +62,87 @@ from matchpath(on
     arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
    )
 POSTHOOK: type: QUERY
+STAGE DEPENDENCIES:
+  Stage-1 is a root stage
+  Stage-0 depends on stages: Stage-1
+
+STAGE PLANS:
+  Stage: Stage-1
+    Spark
+      Edges:
+        Reducer 2 <- Map 1 (PARTITION-LEVEL SORT, 2)
+#### A masked pattern was here ####
+      Vertices:
+        Map 1 
+            Map Operator Tree:
+                TableScan
+                  alias: flights_tiny
+                  Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                  Reduce Output Operator
+                    key expressions: fl_num (type: string), year (type: int), month (type: int), day_of_month (type: int)
+                    sort order: ++++
+                    Map-reduce partition columns: fl_num (type: string)
+                    Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                    value expressions: origin_city_name (type: string), dest_city_name (type: string), year (type: int), month (type: int), day_of_month (type: int), arr_delay (type: float), fl_num (type: string), BLOCK__OFFSET__INSIDE__FILE (type: bigint), INPUT__FILE__NAME (type: string), ROW__ID (type: struct<transactionid:bigint,bucketid:int,rowid:bigint>)
+        Reducer 2 
+            Reduce Operator Tree:
+              Extract
+                Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: flights_tiny
+                        output shape: _col0: string, _col1: string, _col2: int, _col3: int, _col4: int, _col5: float, _col6: string, _col7: bigint, _col8: string, _col9: struct<transactionid:bigint,bucketid:int,rowid:bigint>
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        arguments: 'LATE.LATE+', 'LATE', (_col5 > 15.0), 'origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath'
+                        name: matchpath
+                        order by: _col2, _col3, _col4
+                        output shape: origin_city_name: string, fl_num: string, year: int, month: int, day_of_month: int, sz: int, tpath: int
+                        partition by: _col6
+                        raw input shape:
+                  Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                  Select Operator
+                    expressions: origin_city_name (type: string), fl_num (type: string), year (type: int), month (type: int), day_of_month (type: int), sz (type: int), tpath (type: int)
+                    outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6
+                    Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                    File Output Operator
+                      compressed: false
+                      Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                      table:
+                          input format: org.apache.hadoop.mapred.TextInputFormat
+                          output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
+                          serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
+
+  Stage: Stage-0
+    Fetch Operator
+      limit: -1
+      Processor Tree:
+        ListSink
+
+PREHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        distribute by fl_num 
+        sort by year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+PREHOOK: type: QUERY
+PREHOOK: Input: default@flights_tiny
+#### A masked pattern was here ####
+POSTHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        distribute by fl_num 
+        sort by year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+POSTHOOK: type: QUERY
 POSTHOOK: Input: default@flights_tiny
 #### A masked pattern was here ####
 Baltimore	1142	2010	10	20	6	20
@@ -81,6 +162,7 @@ Chicago	897	2010	10	21	3	21
 Chicago	897	2010	10	22	2	22
 Washington	7291	2010	10	27	2	27
 PREHOOK: query: -- 2. Matchpath on 1 partition
+explain
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
 from matchpath(on 
         flights_tiny 
@@ -91,9 +173,8 @@ from matchpath(on
    )
 where fl_num = 1142
 PREHOOK: type: QUERY
-PREHOOK: Input: default@flights_tiny
-#### A masked pattern was here ####
 POSTHOOK: query: -- 2. Matchpath on 1 partition
+explain
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
 from matchpath(on 
         flights_tiny 
@@ -104,6 +185,90 @@ from matchpath(on
    )
 where fl_num = 1142
 POSTHOOK: type: QUERY
+STAGE DEPENDENCIES:
+  Stage-1 is a root stage
+  Stage-0 depends on stages: Stage-1
+
+STAGE PLANS:
+  Stage: Stage-1
+    Spark
+      Edges:
+        Reducer 2 <- Map 1 (PARTITION-LEVEL SORT, 2)
+#### A masked pattern was here ####
+      Vertices:
+        Map 1 
+            Map Operator Tree:
+                TableScan
+                  alias: flights_tiny
+                  Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                  Reduce Output Operator
+                    key expressions: 0 (type: int), fl_num (type: string), year (type: int), month (type: int), day_of_month (type: int)
+                    sort order: +++++
+                    Map-reduce partition columns: 0 (type: int)
+                    Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                    value expressions: origin_city_name (type: string), dest_city_name (type: string), year (type: int), month (type: int), day_of_month (type: int), arr_delay (type: float), fl_num (type: string), BLOCK__OFFSET__INSIDE__FILE (type: bigint), INPUT__FILE__NAME (type: string), ROW__ID (type: struct<transactionid:bigint,bucketid:int,rowid:bigint>)
+        Reducer 2 
+            Reduce Operator Tree:
+              Extract
+                Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: flights_tiny
+                        output shape: _col0: string, _col1: string, _col2: int, _col3: int, _col4: int, _col5: float, _col6: string, _col7: bigint, _col8: string, _col9: struct<transactionid:bigint,bucketid:int,rowid:bigint>
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        arguments: 'LATE.LATE+', 'LATE', (_col5 > 15.0), 'origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath'
+                        name: matchpath
+                        order by: _col6, _col2, _col3, _col4
+                        output shape: origin_city_name: string, fl_num: string, year: int, month: int, day_of_month: int, sz: int, tpath: int
+                        partition by: 0
+                        raw input shape:
+                  Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                  Filter Operator
+                    predicate: (fl_num = 1142) (type: boolean)
+                    Statistics: Num rows: 8 Data size: 2531 Basic stats: COMPLETE Column stats: NONE
+                    Select Operator
+                      expressions: origin_city_name (type: string), '1142' (type: string), year (type: int), month (type: int), day_of_month (type: int), sz (type: int), tpath (type: int)
+                      outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6
+                      Statistics: Num rows: 8 Data size: 2531 Basic stats: COMPLETE Column stats: NONE
+                      File Output Operator
+                        compressed: false
+                        Statistics: Num rows: 8 Data size: 2531 Basic stats: COMPLETE Column stats: NONE
+                        table:
+                            input format: org.apache.hadoop.mapred.TextInputFormat
+                            output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
+                            serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
+
+  Stage: Stage-0
+    Fetch Operator
+      limit: -1
+      Processor Tree:
+        ListSink
+
+PREHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        sort by fl_num, year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+where fl_num = 1142
+PREHOOK: type: QUERY
+PREHOOK: Input: default@flights_tiny
+#### A masked pattern was here ####
+POSTHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        sort by fl_num, year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+where fl_num = 1142
+POSTHOOK: type: QUERY
 POSTHOOK: Input: default@flights_tiny
 #### A masked pattern was here ####
 Baltimore	1142	2010	10	20	6	20
@@ -112,6 +277,7 @@ Baltimore	1142	2010	10	22	4	22
 Baltimore	1142	2010	10	25	3	25
 Baltimore	1142	2010	10	26	2	26
 PREHOOK: query: -- 3. empty partition.
+explain
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
 from matchpath(on
         (select * from flights_tiny where fl_num = -1142) flights_tiny
@@ -121,9 +287,8 @@ from matchpath(on
     arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
    )
 PREHOOK: type: QUERY
-PREHOOK: Input: default@flights_tiny
-#### A masked pattern was here ####
 POSTHOOK: query: -- 3. empty partition.
+explain
 select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
 from matchpath(on
         (select * from flights_tiny where fl_num = -1142) flights_tiny
@@ -133,5 +298,91 @@ from matchpath(on
     arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
    )
 POSTHOOK: type: QUERY
+STAGE DEPENDENCIES:
+  Stage-1 is a root stage
+  Stage-0 depends on stages: Stage-1
+
+STAGE PLANS:
+  Stage: Stage-1
+    Spark
+      Edges:
+        Reducer 2 <- Map 1 (PARTITION-LEVEL SORT, 2)
+#### A masked pattern was here ####
+      Vertices:
+        Map 1 
+            Map Operator Tree:
+                TableScan
+                  alias: flights_tiny
+                  Statistics: Num rows: 24 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                  Filter Operator
+                    predicate: (fl_num = -1142) (type: boolean)
+                    Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                    Select Operator
+                      expressions: origin_city_name (type: string), dest_city_name (type: string), year (type: int), month (type: int), day_of_month (type: int), arr_delay (type: float)
+                      outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5
+                      Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                      Reduce Output Operator
+                        key expressions: 0 (type: int), '-1142' (type: string), _col2 (type: int), _col3 (type: int), _col4 (type: int)
+                        sort order: +++++
+                        Map-reduce partition columns: 0 (type: int)
+                        Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                        value expressions: _col0 (type: string), _col1 (type: string), _col2 (type: int), _col3 (type: int), _col4 (type: int), _col5 (type: float), '-1142' (type: string)
+        Reducer 2 
+            Reduce Operator Tree:
+              Extract
+                Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: flights_tiny
+                        output shape: _col0: string, _col1: string, _col2: int, _col3: int, _col4: int, _col5: float, _col6: string
+                        type: SUBQUERY
+                      Partition table definition
+                        input alias: ptf_1
+                        arguments: 'LATE.LATE+', 'LATE', (_col5 > 15.0), 'origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath'
+                        name: matchpath
+                        order by: _col6, _col2, _col3, _col4
+                        output shape: origin_city_name: string, fl_num: string, year: int, month: int, day_of_month: int, sz: int, tpath: int
+                        partition by: 0
+                        raw input shape:
+                  Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                  Select Operator
+                    expressions: origin_city_name (type: string), '-1142' (type: string), year (type: int), month (type: int), day_of_month (type: int), sz (type: int), tpath (type: int)
+                    outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6
+                    Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                    File Output Operator
+                      compressed: false
+                      Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                      table:
+                          input format: org.apache.hadoop.mapred.TextInputFormat
+                          output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
+                          serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
+
+  Stage: Stage-0
+    Fetch Operator
+      limit: -1
+      Processor Tree:
+        ListSink
+
+PREHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
+from matchpath(on
+        (select * from flights_tiny where fl_num = -1142) flights_tiny
+        sort by fl_num, year, month, day_of_month
+      arg1('LATE.LATE+'),
+      arg2('LATE'), arg3(arr_delay > 15),
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
+   )
+PREHOOK: type: QUERY
+PREHOOK: Input: default@flights_tiny
+#### A masked pattern was here ####
+POSTHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
+from matchpath(on
+        (select * from flights_tiny where fl_num = -1142) flights_tiny
+        sort by fl_num, year, month, day_of_month
+      arg1('LATE.LATE+'),
+      arg2('LATE'), arg3(arr_delay > 15),
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
+   )
+POSTHOOK: type: QUERY
 POSTHOOK: Input: default@flights_tiny
 #### A masked pattern was here ####
diff --git a/ql/src/test/results/clientpositive/spark/ptf_streaming.q.out b/ql/src/test/results/clientpositive/spark/ptf_streaming.q.out
index cd77c5f..9031fa0 100644
--- a/ql/src/test/results/clientpositive/spark/ptf_streaming.q.out
+++ b/ql/src/test/results/clientpositive/spark/ptf_streaming.q.out
@@ -52,6 +52,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -66,6 +78,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -210,6 +254,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: j
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: SUBQUERY
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -224,6 +280,25 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), (_col5 - _wcol0) (type: int)
@@ -344,6 +419,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noopstreaming
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: _col0 is not null (type: boolean)
@@ -456,7 +543,21 @@ STAGE PLANS:
                   alias: part
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: part
+                          output shape: p_name: string, p_mfgr: string, p_size: int
+                          type: TABLE
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmapstreaming
+                          order by: p_name, p_size(DESC)
+                          output shape: p_name: string, p_mfgr: string, p_size: int
+                          partition by: p_mfgr
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: p_mfgr (type: string), p_name (type: string), p_size (type: int)
                       sort order: ++-
@@ -468,6 +569,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmapstreaming
+                        order by: _col1, _col5(DESC)
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -481,6 +595,25 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1, _col5(DESC)
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1, _col5
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int)
@@ -580,7 +713,21 @@ STAGE PLANS:
                   alias: part
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: part
+                          output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                          type: TABLE
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmapstreaming
+                          order by: p_name
+                          output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                          partition by: p_mfgr
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: p_mfgr (type: string), p_name (type: string)
                       sort order: ++
@@ -592,6 +739,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmapstreaming
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -606,6 +766,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -722,9 +914,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmapstreaming
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noopstreaming
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: +++
@@ -736,6 +961,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmapstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -750,6 +995,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -868,9 +1145,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noopstreaming
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: +++
@@ -882,6 +1192,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -896,6 +1226,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1014,9 +1376,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmapstreaming
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: +++
@@ -1028,6 +1423,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmapstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1042,6 +1457,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1177,6 +1624,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noopstreaming
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: _col0 is not null (type: boolean)
@@ -1210,6 +1669,51 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col1
+                              name: count
+                              window function: GenericUDAFCountEvaluator
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol3
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol4
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: bigint), _col7 (type: double), _wcol3 (type: double), _col5 (type: int), (_col5 - _wcol4) (type: int)
@@ -1348,9 +1852,49 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noopstreaming
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -1362,6 +1906,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -1376,6 +1940,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -1523,6 +2119,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -1535,6 +2150,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -1547,6 +2174,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1561,6 +2200,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -1701,9 +2372,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmapstreaming
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -1715,6 +2419,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmapstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1729,6 +2446,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
diff --git a/ql/src/test/results/clientpositive/spark/sample10.q.out b/ql/src/test/results/clientpositive/spark/sample10.q.out
index b63718b..2d6ca1b 100644
--- a/ql/src/test/results/clientpositive/spark/sample10.q.out
+++ b/ql/src/test/results/clientpositive/spark/sample10.q.out
@@ -102,6 +102,7 @@ STAGE PLANS:
                   Filter Operator
                     isSamplingPred: true
                     predicate: (((hash(key) & 2147483647) % 4) = 0) (type: boolean)
+                    sampleDesc: BUCKET 1 OUT OF 4
                     Statistics: Num rows: 20 Data size: 120 Basic stats: COMPLETE Column stats: NONE
                     Select Operator
                       expressions: ds (type: string)
diff --git a/ql/src/test/results/clientpositive/spark/sample2.q.out b/ql/src/test/results/clientpositive/spark/sample2.q.out
index eac6fb4..d06291c 100644
--- a/ql/src/test/results/clientpositive/spark/sample2.q.out
+++ b/ql/src/test/results/clientpositive/spark/sample2.q.out
@@ -60,6 +60,7 @@ STAGE PLANS:
                   Filter Operator
                     isSamplingPred: true
                     predicate: (((hash(key) & 2147483647) % 2) = 0) (type: boolean)
+                    sampleDesc: BUCKET 1 OUT OF 2
                     Statistics: Num rows: 500 Data size: 5301 Basic stats: COMPLETE Column stats: NONE
                     Select Operator
                       expressions: key (type: int), value (type: string)
diff --git a/ql/src/test/results/clientpositive/spark/sample4.q.out b/ql/src/test/results/clientpositive/spark/sample4.q.out
index 8030f74..ecee494 100644
--- a/ql/src/test/results/clientpositive/spark/sample4.q.out
+++ b/ql/src/test/results/clientpositive/spark/sample4.q.out
@@ -62,6 +62,7 @@ STAGE PLANS:
                   Filter Operator
                     isSamplingPred: true
                     predicate: (((hash(key) & 2147483647) % 2) = 0) (type: boolean)
+                    sampleDesc: BUCKET 1 OUT OF 2
                     Statistics: Num rows: 500 Data size: 5301 Basic stats: COMPLETE Column stats: NONE
                     Select Operator
                       expressions: key (type: int), value (type: string)
diff --git a/ql/src/test/results/clientpositive/spark/sample6.q.out b/ql/src/test/results/clientpositive/spark/sample6.q.out
index 80fda3c..ee8a58c 100644
--- a/ql/src/test/results/clientpositive/spark/sample6.q.out
+++ b/ql/src/test/results/clientpositive/spark/sample6.q.out
@@ -60,6 +60,7 @@ STAGE PLANS:
                   Filter Operator
                     isSamplingPred: true
                     predicate: (((hash(key) & 2147483647) % 4) = 0) (type: boolean)
+                    sampleDesc: BUCKET 1 OUT OF 4
                     Statistics: Num rows: 500 Data size: 5301 Basic stats: COMPLETE Column stats: NONE
                     Select Operator
                       expressions: key (type: int), value (type: string)
@@ -495,6 +496,7 @@ STAGE PLANS:
                   Filter Operator
                     isSamplingPred: true
                     predicate: (((hash(key) & 2147483647) % 4) = 3) (type: boolean)
+                    sampleDesc: BUCKET 4 OUT OF 4
                     Statistics: Num rows: 500 Data size: 5301 Basic stats: COMPLETE Column stats: NONE
                     Select Operator
                       expressions: key (type: int), value (type: string)
@@ -898,6 +900,7 @@ STAGE PLANS:
                   Filter Operator
                     isSamplingPred: true
                     predicate: (((hash(key) & 2147483647) % 2) = 0) (type: boolean)
+                    sampleDesc: BUCKET 1 OUT OF 2
                     Statistics: Num rows: 500 Data size: 5301 Basic stats: COMPLETE Column stats: NONE
                     Select Operator
                       expressions: key (type: int), value (type: string)
@@ -2541,6 +2544,7 @@ STAGE PLANS:
                   Filter Operator
                     isSamplingPred: true
                     predicate: (((hash(key) & 2147483647) % 2) = 0) (type: boolean)
+                    sampleDesc: BUCKET 1 OUT OF 2
                     Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
                     Select Operator
                       expressions: key (type: int), value (type: string)
@@ -2874,6 +2878,7 @@ STAGE PLANS:
                   Filter Operator
                     isSamplingPred: true
                     predicate: (((hash(key) & 2147483647) % 4) = 1) (type: boolean)
+                    sampleDesc: BUCKET 2 OUT OF 4
                     Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
                     Select Operator
                       expressions: key (type: int), value (type: string)
diff --git a/ql/src/test/results/clientpositive/spark/sample9.q.out b/ql/src/test/results/clientpositive/spark/sample9.q.out
index ff5d08e..c9823f7 100644
--- a/ql/src/test/results/clientpositive/spark/sample9.q.out
+++ b/ql/src/test/results/clientpositive/spark/sample9.q.out
@@ -58,6 +58,7 @@ STAGE PLANS:
           Filter Operator
             isSamplingPred: true
             predicate: (((hash(key) & 2147483647) % 2) = 0) (type: boolean)
+            sampleDesc: BUCKET 1 OUT OF 2
             Statistics: Num rows: 500 Data size: 5301 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: key (type: int), value (type: string)
diff --git a/ql/src/test/results/clientpositive/spark/smb_mapjoin_11.q.out b/ql/src/test/results/clientpositive/spark/smb_mapjoin_11.q.out
index 6881804..c3f996f 100644
--- a/ql/src/test/results/clientpositive/spark/smb_mapjoin_11.q.out
+++ b/ql/src/test/results/clientpositive/spark/smb_mapjoin_11.q.out
@@ -1916,6 +1916,7 @@ STAGE PLANS:
           Filter Operator
             isSamplingPred: true
             predicate: (((hash(key) & 2147483647) % 16) = 1) (type: boolean)
+            sampleDesc: BUCKET 2 OUT OF 16
             Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: key (type: int), value (type: string), ds (type: string)
@@ -2007,6 +2008,7 @@ STAGE PLANS:
           Filter Operator
             isSamplingPred: true
             predicate: (((hash(key) & 2147483647) % 16) = 1) (type: boolean)
+            sampleDesc: BUCKET 2 OUT OF 16
             Statistics: Num rows: 514 Data size: 5484 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: key (type: int), value (type: string), ds (type: string)
diff --git a/ql/src/test/results/clientpositive/spark/subquery_in.q.out b/ql/src/test/results/clientpositive/spark/subquery_in.q.out
index 53c28c2..c48482d 100644
--- a/ql/src/test/results/clientpositive/spark/subquery_in.q.out
+++ b/ql/src/test/results/clientpositive/spark/subquery_in.q.out
@@ -314,6 +314,25 @@ STAGE PLANS:
                 outputColumnNames: _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col5
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: (_wcol0 <= 2) (type: boolean)
@@ -463,6 +482,25 @@ STAGE PLANS:
                 outputColumnNames: _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col5
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: ((_wcol0 <= 2) and _col2 is not null) (type: boolean)
diff --git a/ql/src/test/results/clientpositive/spark/vectorized_ptf.q.out b/ql/src/test/results/clientpositive/spark/vectorized_ptf.q.out
index f48b27d..073eefe 100644
--- a/ql/src/test/results/clientpositive/spark/vectorized_ptf.q.out
+++ b/ql/src/test/results/clientpositive/spark/vectorized_ptf.q.out
@@ -302,6 +302,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -319,6 +331,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -677,6 +721,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: j
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: SUBQUERY
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -694,6 +750,25 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), (_col5 - _wcol0) (type: int)
@@ -901,6 +976,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -1159,6 +1246,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1176,6 +1275,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1446,6 +1577,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1463,6 +1606,39 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), (_col5 - _wcol2) (type: int)
@@ -1743,6 +1919,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -1785,6 +1973,39 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col1, _col2
                 Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: string, _col1: string, _col2: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col0
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col2, 1, _col2
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col0 (type: string), _col1 (type: string), _col2 (type: int), _wcol0 (type: int), _wcol1 (type: int), _col2 (type: int), (_col2 - _wcol2) (type: int)
@@ -2077,6 +2298,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     isSamplingPred: false
@@ -2419,6 +2652,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     isSamplingPred: false
@@ -2572,7 +2817,21 @@ STAGE PLANS:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   GatherStats: false
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: part_orc
+                          output shape: p_name: string, p_mfgr: string, p_size: int
+                          type: TABLE
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: p_name, p_size(DESC)
+                          output shape: p_name: string, p_mfgr: string, p_size: int
+                          partition by: p_mfgr
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: p_mfgr (type: string), p_name (type: string), p_size (type: int)
                       sort order: ++-
@@ -2636,6 +2895,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col1, _col5(DESC)
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -2652,6 +2924,25 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1, _col5(DESC)
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1, _col5
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int)
@@ -2846,7 +3137,21 @@ STAGE PLANS:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   GatherStats: false
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: part_orc
+                          output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                          type: TABLE
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: p_name
+                          output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                          partition by: p_mfgr
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: p_mfgr (type: string), p_name (type: string)
                       sort order: ++
@@ -2910,6 +3215,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -2927,6 +3245,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -3188,6 +3538,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -3205,6 +3567,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -3476,9 +3870,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: +++
@@ -3493,6 +3920,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -3510,6 +3957,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -3801,6 +4280,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -3818,6 +4309,30 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5
+                              name: count
+                              window function: GenericUDAFCountEvaluator
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(2)~FOLLOWING(2)
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: bigint), _wcol1 (type: double)
@@ -4253,6 +4768,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     isSamplingPred: false
@@ -4293,6 +4820,51 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col1
+                              name: count
+                              window function: GenericUDAFCountEvaluator
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol3
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol4
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: bigint), _col7 (type: double), _wcol3 (type: double), _col5 (type: int), (_col5 - _wcol4) (type: int)
@@ -4511,6 +5083,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -4808,6 +5392,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: mfgr_price_view
+                        output shape: _col0: string, _col1: string, _col2: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col0
+                        output shape: _col0: string, _col1: string, _col2: double
+                        partition by: _col0
+                        raw input shape:
                   Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col0 (type: string), _col1 (type: string)
@@ -4825,6 +5421,24 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col1, _col2
                 Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: string, _col1: string, _col2: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col0
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(2)~
                   Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col0 (type: string), _col1 (type: string), _col2 (type: double), _wcol0 (type: double)
@@ -5255,6 +5869,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -5294,6 +5940,24 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col5
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(5)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col1 (type: string), _col2 (type: string), _col5 (type: int), _wcol0 (type: bigint)
@@ -5315,6 +5979,45 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col2, _col3, _col6
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: bigint, _col2: string, _col3: string, _col6: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col3, _col2
+                        partition by: _col3
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col3, _col2
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col3, _col2
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol3
+                              arguments: _col3, _col2
+                              name: cume_dist
+                              window function: GenericUDAFCumeDistEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol4
+                              arguments: _col6, true
+                              name: first_value
+                              window function: GenericUDAFFirstValueEvaluator
+                              window frame: PRECEDING(2)~FOLLOWING(2)
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col3 (type: string), _col2 (type: string), _col6 (type: int), UDFToInteger(round(_col0, 1)) (type: int), _wcol1 (type: int), _wcol2 (type: int), _wcol3 (type: double), _wcol4 (type: int)
@@ -5352,6 +6055,16 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -5367,6 +6080,16 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col5 (type: int)
@@ -5772,9 +6495,49 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -5789,6 +6552,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -5806,6 +6589,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -6128,6 +6943,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -6143,6 +6977,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -6158,6 +7004,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -6175,6 +7033,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -6480,6 +7370,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -6495,6 +7404,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -6512,6 +7440,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -6829,6 +7789,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -6844,9 +7823,35 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -6861,6 +7866,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -6878,6 +7896,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -7226,9 +8276,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string)
                       sort order: ++
@@ -7243,6 +8326,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -7260,6 +8363,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
@@ -7574,9 +8709,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -7591,6 +8759,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -7608,6 +8789,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
diff --git a/ql/src/test/results/clientpositive/subquery_in.q.out b/ql/src/test/results/clientpositive/subquery_in.q.out
index 3a5e77b..d4dec94 100644
--- a/ql/src/test/results/clientpositive/subquery_in.q.out
+++ b/ql/src/test/results/clientpositive/subquery_in.q.out
@@ -269,6 +269,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: (_wcol0 <= 2) (type: boolean)
@@ -434,6 +453,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: ((_wcol0 <= 2) and _col0 is not null) (type: boolean)
diff --git a/ql/src/test/results/clientpositive/subquery_in_having.q.out b/ql/src/test/results/clientpositive/subquery_in_having.q.out
index cb2055a..76fe152 100644
--- a/ql/src/test/results/clientpositive/subquery_in_having.q.out
+++ b/ql/src/test/results/clientpositive/subquery_in_having.q.out
@@ -1368,6 +1368,24 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1, _col2
           Statistics: Num rows: 15 Data size: 3173 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string, _col2: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col2
+                  partition by: _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col0
+                        name: first_value
+                        window function: GenericUDAFFirstValueEvaluator
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 15 Data size: 3173 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: _wcol0 is not null (type: boolean)
diff --git a/ql/src/test/results/clientpositive/subquery_notin.q.out b/ql/src/test/results/clientpositive/subquery_notin.q.out
index 077d81f..5e544a9 100644
--- a/ql/src/test/results/clientpositive/subquery_notin.q.out
+++ b/ql/src/test/results/clientpositive/subquery_notin.q.out
@@ -337,6 +337,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1, _col2
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string, _col2: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col2
+                  partition by: _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: ((_wcol0 <= 2) and (_col0 is null or _col1 is null)) (type: boolean)
@@ -477,6 +496,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1, _col2
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string, _col2: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col2
+                  partition by: _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: (_wcol0 <= 2) (type: boolean)
@@ -589,6 +627,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: (_wcol0 <= 2) (type: boolean)
@@ -721,6 +778,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: (_wcol0 <= 2) (type: boolean)
@@ -881,6 +957,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: (_wcol0 <= 2) (type: boolean)
@@ -1057,6 +1152,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: (_wcol0 <= 2) (type: boolean)
diff --git a/ql/src/test/results/clientpositive/subquery_unqualcolumnrefs.q.out b/ql/src/test/results/clientpositive/subquery_unqualcolumnrefs.q.out
index 017ad4b..1dd14b9 100644
--- a/ql/src/test/results/clientpositive/subquery_unqualcolumnrefs.q.out
+++ b/ql/src/test/results/clientpositive/subquery_unqualcolumnrefs.q.out
@@ -222,6 +222,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 1 Data size: 0 Basic stats: PARTIAL Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 1 Data size: 0 Basic stats: PARTIAL Column stats: NONE
             Filter Operator
               predicate: ((_wcol0 <= 2) and _col0 is not null) (type: boolean)
@@ -375,6 +394,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: ((_wcol0 <= 2) and _col0 is not null) (type: boolean)
@@ -807,6 +845,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1, _col2
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string, _col2: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col2
+                  partition by: _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: ((_wcol0 <= 2) and (_col0 is null or _col1 is null)) (type: boolean)
@@ -947,6 +1004,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1, _col2
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string, _col2: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col2
+                  partition by: _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: (_wcol0 <= 2) (type: boolean)
diff --git a/ql/src/test/results/clientpositive/tez/ptf.q.out b/ql/src/test/results/clientpositive/tez/ptf.q.out
index 9da73d3..b688ec0 100644
--- a/ql/src/test/results/clientpositive/tez/ptf.q.out
+++ b/ql/src/test/results/clientpositive/tez/ptf.q.out
@@ -52,6 +52,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -66,6 +78,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -210,6 +254,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: j
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: SUBQUERY
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -224,6 +280,25 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), (_col5 - _wcol0) (type: int)
@@ -328,6 +403,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -437,6 +524,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -451,6 +550,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -568,6 +699,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -582,6 +725,39 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), (_col5 - _wcol2) (type: int)
@@ -702,6 +878,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -737,6 +925,39 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col1, _col2
                 Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: string, _col1: string, _col2: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col0
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col2, 1, _col2
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col0 (type: string), _col1 (type: string), _col2 (type: int), _wcol0 (type: int), _wcol1 (type: int), _col2 (type: int), (_col2 - _wcol2) (type: int)
@@ -862,6 +1083,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: _col0 is not null (type: boolean)
@@ -1018,6 +1251,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: _col0 is not null (type: boolean)
@@ -1113,7 +1358,21 @@ STAGE PLANS:
                   alias: part
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: part
+                          output shape: p_name: string, p_mfgr: string, p_size: int
+                          type: TABLE
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: p_name, p_size(DESC)
+                          output shape: p_name: string, p_mfgr: string, p_size: int
+                          partition by: p_mfgr
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: p_mfgr (type: string), p_name (type: string), p_size (type: int)
                       sort order: ++-
@@ -1125,6 +1384,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col1, _col5(DESC)
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -1138,6 +1410,25 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1, _col5(DESC)
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1, _col5
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int)
@@ -1237,7 +1528,21 @@ STAGE PLANS:
                   alias: part
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: part
+                          output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                          type: TABLE
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: p_name
+                          output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                          partition by: p_mfgr
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: p_mfgr (type: string), p_name (type: string)
                       sort order: ++
@@ -1249,6 +1554,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1263,6 +1581,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1376,6 +1726,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1390,6 +1752,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1506,9 +1900,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2(DESC), _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2(DESC), _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2(DESC), _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: +++
@@ -1520,6 +1947,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2(DESC), _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2(DESC), _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1534,6 +1981,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1657,6 +2136,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1671,6 +2162,30 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5
+                              name: count
+                              window function: GenericUDAFCountEvaluator
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(2)~FOLLOWING(2)
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: bigint), _wcol1 (type: double)
@@ -1812,6 +2327,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: _col0 is not null (type: boolean)
@@ -1845,6 +2372,51 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col1
+                              name: count
+                              window function: GenericUDAFCountEvaluator
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol3
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol4
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: bigint), _col7 (type: double), _wcol3 (type: double), _col5 (type: int), (_col5 - _wcol4) (type: int)
@@ -1960,6 +2532,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -2124,6 +2708,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: mfgr_price_view
+                        output shape: _col0: string, _col1: string, _col2: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col0
+                        output shape: _col0: string, _col1: string, _col2: double
+                        partition by: _col0
+                        raw input shape:
                   Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col0 (type: string), _col1 (type: string)
@@ -2138,6 +2734,24 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col1, _col2
                 Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: string, _col1: string, _col2: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col0
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(2)~
                   Statistics: Num rows: 13 Data size: 1573 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col0 (type: string), _col1 (type: string), _col2 (type: double), _wcol0 (type: double)
@@ -2305,6 +2919,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -2325,6 +2951,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -2345,6 +3003,24 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col5
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(5)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col1 (type: string), _col2 (type: string), _col5 (type: int), _wcol0 (type: bigint)
@@ -2363,6 +3039,45 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col2, _col3, _col6
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: bigint, _col2: string, _col3: string, _col6: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col3, _col2
+                        partition by: _col3
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col3, _col2
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col3, _col2
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol3
+                              arguments: _col3, _col2
+                              name: cume_dist
+                              window function: GenericUDAFCumeDistEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol4
+                              arguments: _col6, true
+                              name: first_value
+                              window function: GenericUDAFFirstValueEvaluator
+                              window frame: PRECEDING(2)~FOLLOWING(2)
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col3 (type: string), _col2 (type: string), _col6 (type: int), UDFToInteger(round(_col0, 1)) (type: int), _wcol1 (type: int), _wcol2 (type: int), _wcol3 (type: double), _wcol4 (type: int)
@@ -2589,9 +3304,49 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -2603,6 +3358,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -2617,6 +3392,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -2764,6 +3571,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -2776,6 +3602,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -2788,6 +3626,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -2802,6 +3652,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -2944,6 +3826,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -2956,6 +3857,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -2970,6 +3890,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -3113,6 +4065,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -3125,9 +4096,35 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -3139,6 +4136,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -3153,6 +4163,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -3297,9 +4339,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string)
                       sort order: ++
@@ -3311,6 +4386,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -3325,6 +4420,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
@@ -3463,9 +4590,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -3477,6 +4637,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -3491,6 +4664,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
diff --git a/ql/src/test/results/clientpositive/tez/ptf_matchpath.q.out b/ql/src/test/results/clientpositive/tez/ptf_matchpath.q.out
new file mode 100644
index 0000000..fc2b034
--- /dev/null
+++ b/ql/src/test/results/clientpositive/tez/ptf_matchpath.q.out
@@ -0,0 +1,394 @@
+PREHOOK: query: DROP TABLE flights_tiny
+PREHOOK: type: DROPTABLE
+POSTHOOK: query: DROP TABLE flights_tiny
+POSTHOOK: type: DROPTABLE
+PREHOOK: query: create table flights_tiny ( 
+ORIGIN_CITY_NAME string, 
+DEST_CITY_NAME string, 
+YEAR int, 
+MONTH int, 
+DAY_OF_MONTH int, 
+ARR_DELAY float, 
+FL_NUM string 
+)
+PREHOOK: type: CREATETABLE
+PREHOOK: Output: database:default
+PREHOOK: Output: default@flights_tiny
+POSTHOOK: query: create table flights_tiny ( 
+ORIGIN_CITY_NAME string, 
+DEST_CITY_NAME string, 
+YEAR int, 
+MONTH int, 
+DAY_OF_MONTH int, 
+ARR_DELAY float, 
+FL_NUM string 
+)
+POSTHOOK: type: CREATETABLE
+POSTHOOK: Output: database:default
+POSTHOOK: Output: default@flights_tiny
+PREHOOK: query: LOAD DATA LOCAL INPATH '../../data/files/flights_tiny.txt' OVERWRITE INTO TABLE flights_tiny
+PREHOOK: type: LOAD
+#### A masked pattern was here ####
+PREHOOK: Output: default@flights_tiny
+POSTHOOK: query: LOAD DATA LOCAL INPATH '../../data/files/flights_tiny.txt' OVERWRITE INTO TABLE flights_tiny
+POSTHOOK: type: LOAD
+#### A masked pattern was here ####
+POSTHOOK: Output: default@flights_tiny
+PREHOOK: query: -- SORT_QUERY_RESULTS
+
+-- 1. basic Matchpath test
+explain
+select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        distribute by fl_num 
+        sort by year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+PREHOOK: type: QUERY
+POSTHOOK: query: -- SORT_QUERY_RESULTS
+
+-- 1. basic Matchpath test
+explain
+select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        distribute by fl_num 
+        sort by year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+POSTHOOK: type: QUERY
+STAGE DEPENDENCIES:
+  Stage-1 is a root stage
+  Stage-0 depends on stages: Stage-1
+
+STAGE PLANS:
+  Stage: Stage-1
+    Tez
+      Edges:
+        Reducer 2 <- Map 1 (SIMPLE_EDGE)
+#### A masked pattern was here ####
+      Vertices:
+        Map 1 
+            Map Operator Tree:
+                TableScan
+                  alias: flights_tiny
+                  Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                  Reduce Output Operator
+                    key expressions: fl_num (type: string), year (type: int), month (type: int), day_of_month (type: int)
+                    sort order: ++++
+                    Map-reduce partition columns: fl_num (type: string)
+                    Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                    value expressions: origin_city_name (type: string), dest_city_name (type: string), arr_delay (type: float), BLOCK__OFFSET__INSIDE__FILE (type: bigint), INPUT__FILE__NAME (type: string), ROW__ID (type: struct<transactionid:bigint,bucketid:int,rowid:bigint>)
+        Reducer 2 
+            Reduce Operator Tree:
+              Select Operator
+                expressions: VALUE._col0 (type: string), VALUE._col1 (type: string), KEY.reducesinkkey1 (type: int), KEY.reducesinkkey2 (type: int), KEY.reducesinkkey3 (type: int), VALUE._col2 (type: float), KEY.reducesinkkey0 (type: string), VALUE._col3 (type: bigint), VALUE._col4 (type: string), VALUE._col5 (type: struct<transactionid:bigint,bucketid:int,rowid:bigint>)
+                outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6, _col7, _col8, _col9
+                Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: flights_tiny
+                        output shape: _col0: string, _col1: string, _col2: int, _col3: int, _col4: int, _col5: float, _col6: string, _col7: bigint, _col8: string, _col9: struct<transactionid:bigint,bucketid:int,rowid:bigint>
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        arguments: 'LATE.LATE+', 'LATE', (_col5 > 15.0), 'origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath'
+                        name: matchpath
+                        order by: _col2, _col3, _col4
+                        output shape: origin_city_name: string, fl_num: string, year: int, month: int, day_of_month: int, sz: int, tpath: int
+                        partition by: _col6
+                        raw input shape:
+                  Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                  Select Operator
+                    expressions: origin_city_name (type: string), fl_num (type: string), year (type: int), month (type: int), day_of_month (type: int), sz (type: int), tpath (type: int)
+                    outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6
+                    Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                    File Output Operator
+                      compressed: false
+                      Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                      table:
+                          input format: org.apache.hadoop.mapred.TextInputFormat
+                          output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
+                          serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
+
+  Stage: Stage-0
+    Fetch Operator
+      limit: -1
+      Processor Tree:
+        ListSink
+
+PREHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        distribute by fl_num 
+        sort by year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+PREHOOK: type: QUERY
+PREHOOK: Input: default@flights_tiny
+#### A masked pattern was here ####
+POSTHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        distribute by fl_num 
+        sort by year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+POSTHOOK: type: QUERY
+POSTHOOK: Input: default@flights_tiny
+#### A masked pattern was here ####
+Baltimore	1142	2010	10	20	6	20
+Baltimore	1142	2010	10	21	5	21
+Baltimore	1142	2010	10	22	4	22
+Baltimore	1142	2010	10	25	3	25
+Baltimore	1142	2010	10	26	2	26
+Baltimore	1599	2010	10	21	2	21
+Baltimore	1599	2010	10	25	3	25
+Baltimore	1599	2010	10	26	2	26
+Chicago	1531	2010	10	21	2	21
+Chicago	1531	2010	10	25	3	25
+Chicago	1531	2010	10	26	2	26
+Chicago	361	2010	10	20	2	20
+Chicago	897	2010	10	20	4	20
+Chicago	897	2010	10	21	3	21
+Chicago	897	2010	10	22	2	22
+Washington	7291	2010	10	27	2	27
+PREHOOK: query: -- 2. Matchpath on 1 partition
+explain
+select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        sort by fl_num, year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+where fl_num = 1142
+PREHOOK: type: QUERY
+POSTHOOK: query: -- 2. Matchpath on 1 partition
+explain
+select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        sort by fl_num, year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+where fl_num = 1142
+POSTHOOK: type: QUERY
+STAGE DEPENDENCIES:
+  Stage-1 is a root stage
+  Stage-0 depends on stages: Stage-1
+
+STAGE PLANS:
+  Stage: Stage-1
+    Tez
+      Edges:
+        Reducer 2 <- Map 1 (SIMPLE_EDGE)
+#### A masked pattern was here ####
+      Vertices:
+        Map 1 
+            Map Operator Tree:
+                TableScan
+                  alias: flights_tiny
+                  Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                  Reduce Output Operator
+                    key expressions: 0 (type: int), fl_num (type: string), year (type: int), month (type: int), day_of_month (type: int)
+                    sort order: +++++
+                    Map-reduce partition columns: 0 (type: int)
+                    Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                    value expressions: origin_city_name (type: string), dest_city_name (type: string), arr_delay (type: float), BLOCK__OFFSET__INSIDE__FILE (type: bigint), INPUT__FILE__NAME (type: string), ROW__ID (type: struct<transactionid:bigint,bucketid:int,rowid:bigint>)
+        Reducer 2 
+            Reduce Operator Tree:
+              Select Operator
+                expressions: VALUE._col0 (type: string), VALUE._col1 (type: string), KEY.reducesinkkey2 (type: int), KEY.reducesinkkey3 (type: int), KEY.reducesinkkey4 (type: int), VALUE._col2 (type: float), KEY.reducesinkkey1 (type: string), VALUE._col3 (type: bigint), VALUE._col4 (type: string), VALUE._col5 (type: struct<transactionid:bigint,bucketid:int,rowid:bigint>)
+                outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6, _col7, _col8, _col9
+                Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: flights_tiny
+                        output shape: _col0: string, _col1: string, _col2: int, _col3: int, _col4: int, _col5: float, _col6: string, _col7: bigint, _col8: string, _col9: struct<transactionid:bigint,bucketid:int,rowid:bigint>
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        arguments: 'LATE.LATE+', 'LATE', (_col5 > 15.0), 'origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath'
+                        name: matchpath
+                        order by: _col6, _col2, _col3, _col4
+                        output shape: origin_city_name: string, fl_num: string, year: int, month: int, day_of_month: int, sz: int, tpath: int
+                        partition by: 0
+                        raw input shape:
+                  Statistics: Num rows: 17 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                  Filter Operator
+                    predicate: (fl_num = 1142) (type: boolean)
+                    Statistics: Num rows: 8 Data size: 2531 Basic stats: COMPLETE Column stats: NONE
+                    Select Operator
+                      expressions: origin_city_name (type: string), '1142' (type: string), year (type: int), month (type: int), day_of_month (type: int), sz (type: int), tpath (type: int)
+                      outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6
+                      Statistics: Num rows: 8 Data size: 2531 Basic stats: COMPLETE Column stats: NONE
+                      File Output Operator
+                        compressed: false
+                        Statistics: Num rows: 8 Data size: 2531 Basic stats: COMPLETE Column stats: NONE
+                        table:
+                            input format: org.apache.hadoop.mapred.TextInputFormat
+                            output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
+                            serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
+
+  Stage: Stage-0
+    Fetch Operator
+      limit: -1
+      Processor Tree:
+        ListSink
+
+PREHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        sort by fl_num, year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+where fl_num = 1142
+PREHOOK: type: QUERY
+PREHOOK: Input: default@flights_tiny
+#### A masked pattern was here ####
+POSTHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath 
+from matchpath(on 
+        flights_tiny 
+        sort by fl_num, year, month, day_of_month  
+      arg1('LATE.LATE+'), 
+      arg2('LATE'), arg3(arr_delay > 15), 
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath') 
+   )
+where fl_num = 1142
+POSTHOOK: type: QUERY
+POSTHOOK: Input: default@flights_tiny
+#### A masked pattern was here ####
+Baltimore	1142	2010	10	20	6	20
+Baltimore	1142	2010	10	21	5	21
+Baltimore	1142	2010	10	22	4	22
+Baltimore	1142	2010	10	25	3	25
+Baltimore	1142	2010	10	26	2	26
+PREHOOK: query: -- 3. empty partition.
+explain
+select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
+from matchpath(on
+        (select * from flights_tiny where fl_num = -1142) flights_tiny
+        sort by fl_num, year, month, day_of_month
+      arg1('LATE.LATE+'),
+      arg2('LATE'), arg3(arr_delay > 15),
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
+   )
+PREHOOK: type: QUERY
+POSTHOOK: query: -- 3. empty partition.
+explain
+select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
+from matchpath(on
+        (select * from flights_tiny where fl_num = -1142) flights_tiny
+        sort by fl_num, year, month, day_of_month
+      arg1('LATE.LATE+'),
+      arg2('LATE'), arg3(arr_delay > 15),
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
+   )
+POSTHOOK: type: QUERY
+STAGE DEPENDENCIES:
+  Stage-1 is a root stage
+  Stage-0 depends on stages: Stage-1
+
+STAGE PLANS:
+  Stage: Stage-1
+    Tez
+      Edges:
+        Reducer 2 <- Map 1 (SIMPLE_EDGE)
+#### A masked pattern was here ####
+      Vertices:
+        Map 1 
+            Map Operator Tree:
+                TableScan
+                  alias: flights_tiny
+                  Statistics: Num rows: 24 Data size: 5379 Basic stats: COMPLETE Column stats: NONE
+                  Filter Operator
+                    predicate: (fl_num = -1142) (type: boolean)
+                    Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                    Select Operator
+                      expressions: origin_city_name (type: string), dest_city_name (type: string), year (type: int), month (type: int), day_of_month (type: int), arr_delay (type: float)
+                      outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5
+                      Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                      Reduce Output Operator
+                        key expressions: 0 (type: int), '-1142' (type: string), _col2 (type: int), _col3 (type: int), _col4 (type: int)
+                        sort order: +++++
+                        Map-reduce partition columns: 0 (type: int)
+                        Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                        value expressions: _col0 (type: string), _col1 (type: string), _col5 (type: float)
+        Reducer 2 
+            Reduce Operator Tree:
+              Select Operator
+                expressions: VALUE._col0 (type: string), VALUE._col1 (type: string), KEY.reducesinkkey2 (type: int), KEY.reducesinkkey3 (type: int), KEY.reducesinkkey4 (type: int), VALUE._col2 (type: float), '-1142' (type: string)
+                outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6
+                Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: flights_tiny
+                        output shape: _col0: string, _col1: string, _col2: int, _col3: int, _col4: int, _col5: float, _col6: string
+                        type: SUBQUERY
+                      Partition table definition
+                        input alias: ptf_1
+                        arguments: 'LATE.LATE+', 'LATE', (_col5 > 15.0), 'origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath'
+                        name: matchpath
+                        order by: _col6, _col2, _col3, _col4
+                        output shape: origin_city_name: string, fl_num: string, year: int, month: int, day_of_month: int, sz: int, tpath: int
+                        partition by: 0
+                        raw input shape:
+                  Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                  Select Operator
+                    expressions: origin_city_name (type: string), '-1142' (type: string), year (type: int), month (type: int), day_of_month (type: int), sz (type: int), tpath (type: int)
+                    outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6
+                    Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                    File Output Operator
+                      compressed: false
+                      Statistics: Num rows: 12 Data size: 2689 Basic stats: COMPLETE Column stats: NONE
+                      table:
+                          input format: org.apache.hadoop.mapred.TextInputFormat
+                          output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
+                          serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
+
+  Stage: Stage-0
+    Fetch Operator
+      limit: -1
+      Processor Tree:
+        ListSink
+
+PREHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
+from matchpath(on
+        (select * from flights_tiny where fl_num = -1142) flights_tiny
+        sort by fl_num, year, month, day_of_month
+      arg1('LATE.LATE+'),
+      arg2('LATE'), arg3(arr_delay > 15),
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
+   )
+PREHOOK: type: QUERY
+PREHOOK: Input: default@flights_tiny
+#### A masked pattern was here ####
+POSTHOOK: query: select origin_city_name, fl_num, year, month, day_of_month, sz, tpath
+from matchpath(on
+        (select * from flights_tiny where fl_num = -1142) flights_tiny
+        sort by fl_num, year, month, day_of_month
+      arg1('LATE.LATE+'),
+      arg2('LATE'), arg3(arr_delay > 15),
+    arg4('origin_city_name, fl_num, year, month, day_of_month, size(tpath) as sz, tpath[0].day_of_month as tpath')
+   )
+POSTHOOK: type: QUERY
+POSTHOOK: Input: default@flights_tiny
+#### A masked pattern was here ####
diff --git a/ql/src/test/results/clientpositive/tez/ptf_streaming.q.out b/ql/src/test/results/clientpositive/tez/ptf_streaming.q.out
index 9f35f22..cdbbe6c 100644
--- a/ql/src/test/results/clientpositive/tez/ptf_streaming.q.out
+++ b/ql/src/test/results/clientpositive/tez/ptf_streaming.q.out
@@ -52,6 +52,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -66,6 +78,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -210,6 +254,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: j
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: SUBQUERY
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -224,6 +280,25 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), (_col5 - _wcol0) (type: int)
@@ -344,6 +419,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noopstreaming
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: _col0 is not null (type: boolean)
@@ -456,7 +543,21 @@ STAGE PLANS:
                   alias: part
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: part
+                          output shape: p_name: string, p_mfgr: string, p_size: int
+                          type: TABLE
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmapstreaming
+                          order by: p_name, p_size(DESC)
+                          output shape: p_name: string, p_mfgr: string, p_size: int
+                          partition by: p_mfgr
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: p_mfgr (type: string), p_name (type: string), p_size (type: int)
                       sort order: ++-
@@ -468,6 +569,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmapstreaming
+                        order by: _col1, _col5(DESC)
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -481,6 +595,25 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1, _col5(DESC)
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1, _col5
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int)
@@ -580,7 +713,21 @@ STAGE PLANS:
                   alias: part
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: part
+                          output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                          type: TABLE
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmapstreaming
+                          order by: p_name
+                          output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                          partition by: p_mfgr
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: p_mfgr (type: string), p_name (type: string)
                       sort order: ++
@@ -592,6 +739,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmapstreaming
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -606,6 +766,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -722,9 +914,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmapstreaming
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noopstreaming
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: +++
@@ -736,6 +961,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmapstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -750,6 +995,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -868,9 +1145,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noopstreaming
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: +++
@@ -882,6 +1192,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -896,6 +1226,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1014,9 +1376,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmapstreaming
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: +++
@@ -1028,6 +1423,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmapstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1042,6 +1457,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1177,6 +1624,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noopstreaming
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: _col0 is not null (type: boolean)
@@ -1210,6 +1669,51 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col1
+                              name: count
+                              window function: GenericUDAFCountEvaluator
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol3
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol4
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 14 Data size: 1730 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: bigint), _col7 (type: double), _wcol3 (type: double), _col5 (type: int), (_col5 - _wcol4) (type: int)
@@ -1348,9 +1852,49 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noopstreaming
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -1362,6 +1906,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -1376,6 +1940,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -1523,6 +2119,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -1535,6 +2150,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -1547,6 +2174,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1561,6 +2200,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -1701,9 +2372,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmapstreaming
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -1715,6 +2419,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmapstreaming
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1729,6 +2446,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
diff --git a/ql/src/test/results/clientpositive/tez/subquery_in.q.out b/ql/src/test/results/clientpositive/tez/subquery_in.q.out
index 69eb568..f84277c 100644
--- a/ql/src/test/results/clientpositive/tez/subquery_in.q.out
+++ b/ql/src/test/results/clientpositive/tez/subquery_in.q.out
@@ -326,6 +326,25 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col1
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: string, _col1: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col0
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: (_wcol0 <= 2) (type: boolean)
@@ -483,6 +502,25 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col1
                 Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: string, _col1: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col0
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     predicate: ((_wcol0 <= 2) and _col0 is not null) (type: boolean)
diff --git a/ql/src/test/results/clientpositive/tez/vectorized_ptf.q.out b/ql/src/test/results/clientpositive/tez/vectorized_ptf.q.out
index 3b89d61..17ac210 100644
--- a/ql/src/test/results/clientpositive/tez/vectorized_ptf.q.out
+++ b/ql/src/test/results/clientpositive/tez/vectorized_ptf.q.out
@@ -302,6 +302,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -319,6 +331,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -678,6 +722,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: j
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: SUBQUERY
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -695,6 +751,25 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), (_col5 - _wcol0) (type: int)
@@ -902,6 +977,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -1160,6 +1247,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1177,6 +1276,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1447,6 +1578,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -1464,6 +1607,39 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), (_col5 - _wcol2) (type: int)
@@ -1744,6 +1920,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -1786,6 +1974,39 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col1, _col2
                 Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: string, _col1: string, _col2: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col0
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col2, 1, _col2
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col0 (type: string), _col1 (type: string), _col2 (type: int), _wcol0 (type: int), _wcol1 (type: int), _col2 (type: int), (_col2 - _wcol2) (type: int)
@@ -2078,6 +2299,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     isSamplingPred: false
@@ -2422,6 +2655,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     isSamplingPred: false
@@ -2575,7 +2820,21 @@ STAGE PLANS:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   GatherStats: false
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: part_orc
+                          output shape: p_name: string, p_mfgr: string, p_size: int
+                          type: TABLE
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: p_name, p_size(DESC)
+                          output shape: p_name: string, p_mfgr: string, p_size: int
+                          partition by: p_mfgr
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: p_mfgr (type: string), p_name (type: string), p_size (type: int)
                       sort order: ++-
@@ -2639,6 +2898,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col1, _col5(DESC)
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -2655,6 +2927,25 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1, _col5(DESC)
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1, _col5
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int)
@@ -2849,7 +3140,21 @@ STAGE PLANS:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   GatherStats: false
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: part_orc
+                          output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                          type: TABLE
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: p_name
+                          output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                          partition by: p_mfgr
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: p_mfgr (type: string), p_name (type: string)
                       sort order: ++
@@ -2913,6 +3218,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -2930,6 +3248,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -3191,6 +3541,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -3208,6 +3570,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -3479,9 +3873,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: +++
@@ -3496,6 +3923,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -3513,6 +3960,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -3804,6 +4283,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -3821,6 +4312,30 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5
+                              name: count
+                              window function: GenericUDAFCountEvaluator
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(2)~FOLLOWING(2)
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: bigint), _wcol1 (type: double)
@@ -4256,6 +4771,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: abc
+                        name: noop
+                        order by: _col1
+                        output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Filter Operator
                     isSamplingPred: false
@@ -4297,6 +4824,51 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col1
+                              name: count
+                              window function: GenericUDAFCountEvaluator
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol3
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
+                            window function definition
+                              alias: _wcol4
+                              arguments: _col5, 1, _col5
+                              name: lag
+                              window function: GenericUDAFLagEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
                   Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: bigint), _col7 (type: double), _wcol3 (type: double), _col5 (type: int), (_col5 - _wcol4) (type: int)
@@ -4515,6 +5087,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -4812,6 +5396,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: mfgr_price_view
+                        output shape: _col0: string, _col1: string, _col2: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col0
+                        output shape: _col0: string, _col1: string, _col2: double
+                        partition by: _col0
+                        raw input shape:
                   Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col0 (type: string), _col1 (type: string)
@@ -4829,6 +5425,24 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col1, _col2
                 Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: string, _col1: string, _col2: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col0
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(2)~
                   Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col0 (type: string), _col1 (type: string), _col2 (type: double), _wcol0 (type: double)
@@ -5257,6 +5871,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col1
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -5282,6 +5908,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5, _col7
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col7
+                              name: sum
+                              window function: GenericUDAFSumDouble
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -5321,6 +5979,24 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col5
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(5)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col1 (type: string), _col2 (type: string), _col5 (type: int), _wcol0 (type: bigint)
@@ -5342,6 +6018,45 @@ STAGE PLANS:
                 outputColumnNames: _col0, _col2, _col3, _col6
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col0: bigint, _col2: string, _col3: string, _col6: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col3, _col2
+                        partition by: _col3
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col3, _col2
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col3, _col2
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol3
+                              arguments: _col3, _col2
+                              name: cume_dist
+                              window function: GenericUDAFCumeDistEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol4
+                              arguments: _col6, true
+                              name: first_value
+                              window function: GenericUDAFFirstValueEvaluator
+                              window frame: PRECEDING(2)~FOLLOWING(2)
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col3 (type: string), _col2 (type: string), _col6 (type: int), UDFToInteger(round(_col0, 1)) (type: int), _wcol1 (type: int), _wcol2 (type: int), _wcol3 (type: double), _wcol4 (type: int)
@@ -5772,9 +6487,49 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -5789,6 +6544,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -5806,6 +6581,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -6128,6 +6935,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -6143,6 +6969,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -6158,6 +6996,18 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -6175,6 +7025,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -6480,6 +7362,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -6495,6 +7396,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -6512,6 +7432,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -6829,6 +7781,25 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col2 (type: string)
@@ -6844,9 +7815,35 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -6861,6 +7858,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -6878,6 +7888,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -7226,9 +8268,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2
+                          raw input shape:
+                          transforms raw input: true
+                        Partition table definition
+                          input alias: ptf_2
+                          name: noop
+                          order by: _col2
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2
+                          raw input shape:
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col2 (type: string)
                       sort order: ++
@@ -7243,6 +8318,26 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
+                        transforms raw input: true
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
@@ -7260,6 +8355,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col2, _col1
+                        partition by: _col2, _col1
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col2, _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col2, _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
@@ -7574,9 +8701,42 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: part_orc
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: TABLE
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                      Partition table definition
+                        input alias: ptf_2
+                        name: noop
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   PTF Operator
+                    Function definitions:
+                        Input definition
+                          input alias: ptf_0
+                          output shape: _col1: string, _col2: string, _col5: int
+                          type: PTFCOMPONENT
+                        Partition table definition
+                          input alias: ptf_1
+                          name: noopwithmap
+                          order by: _col2, _col1
+                          output shape: _col1: string, _col2: string, _col5: int
+                          partition by: _col2, _col1
+                          raw input shape:
+                          transforms raw input: true
                     Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+                    Map-side function: true
                     Reduce Output Operator
                       key expressions: _col2 (type: string), _col1 (type: string), _col2 (type: string), _col1 (type: string)
                       sort order: ++++
@@ -7591,6 +8751,19 @@ STAGE PLANS:
               Extract
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: PTFCOMPONENT
+                      Partition table definition
+                        input alias: ptf_1
+                        name: noopwithmap
+                        order by: _col2, _col1
+                        output shape: _col1: string, _col2: string, _col5: int
+                        partition by: _col2, _col1
+                        raw input shape:
+                        transforms raw input: true
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Reduce Output Operator
                     key expressions: _col2 (type: string), _col1 (type: string)
@@ -7608,6 +8781,38 @@ STAGE PLANS:
                 outputColumnNames: _col1, _col2, _col5
                 Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                 PTF Operator
+                  Function definitions:
+                      Input definition
+                        input alias: ptf_0
+                        output shape: _col1: string, _col2: string, _col5: int
+                        type: WINDOWING
+                      Windowing table definition
+                        input alias: ptf_1
+                        name: windowingtablefunction
+                        order by: _col1
+                        partition by: _col2
+                        raw input shape:
+                        window functions:
+                            window function definition
+                              alias: _wcol0
+                              arguments: _col1
+                              name: rank
+                              window function: GenericUDAFRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol1
+                              arguments: _col1
+                              name: dense_rank
+                              window function: GenericUDAFDenseRankEvaluator
+                              window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                              isPivotResult: true
+                            window function definition
+                              alias: _wcol2
+                              arguments: _col5
+                              name: sum
+                              window function: GenericUDAFSumLong
+                              window frame: PRECEDING(MAX)~
                   Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
                   Select Operator
                     expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
diff --git a/ql/src/test/results/clientpositive/union_remove_6_subq.q.out b/ql/src/test/results/clientpositive/union_remove_6_subq.q.out
index 3fa5149..f1a299d 100644
--- a/ql/src/test/results/clientpositive/union_remove_6_subq.q.out
+++ b/ql/src/test/results/clientpositive/union_remove_6_subq.q.out
@@ -546,6 +546,24 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: bigint
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: avg
+                        window function: GenericUDAFAverageEvaluatorDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col0 (type: string), _wcol0 (type: double)
diff --git a/ql/src/test/results/clientpositive/vectorized_ptf.q.out b/ql/src/test/results/clientpositive/vectorized_ptf.q.out
index ff7b72c..529fa72 100644
--- a/ql/src/test/results/clientpositive/vectorized_ptf.q.out
+++ b/ql/src/test/results/clientpositive/vectorized_ptf.q.out
@@ -296,6 +296,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -360,6 +372,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -707,6 +751,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: j
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: SUBQUERY
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -771,6 +827,25 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col5, 1, _col5
+                        name: lag
+                        window function: GenericUDAFLagEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), (_col5 - _wcol0) (type: int)
@@ -972,6 +1047,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -1224,6 +1311,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: abc
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1288,6 +1387,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -1552,6 +1683,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -1616,6 +1759,39 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5, 1, _col5
+                        name: lag
+                        window function: GenericUDAFLagEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), (_col5 - _wcol2) (type: int)
@@ -1890,6 +2066,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -2025,6 +2213,39 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1, _col2
           Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string, _col2: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col2, 1, _col2
+                        name: lag
+                        window function: GenericUDAFLagEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col0 (type: string), _col1 (type: string), _col2 (type: int), _wcol0 (type: int), _wcol1 (type: int), _col2 (type: int), (_col2 - _wcol2) (type: int)
@@ -2244,6 +2465,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                  type: TABLE
+                Partition table definition
+                  input alias: abc
+                  name: noop
+                  order by: _col1
+                  output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               isSamplingPred: false
@@ -2584,6 +2817,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                  type: TABLE
+                Partition table definition
+                  input alias: abc
+                  name: noop
+                  order by: _col1
+                  output shape: _col0: int, _col1: string, _col2: string, _col3: string, _col4: string, _col5: int, _col6: string, _col7: double, _col8: string
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               isSamplingPred: false
@@ -2875,7 +3120,21 @@ STAGE PLANS:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             GatherStats: false
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: part_orc
+                    output shape: p_name: string, p_mfgr: string, p_size: int
+                    type: TABLE
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: p_name, p_size(DESC)
+                    output shape: p_name: string, p_mfgr: string, p_size: int
+                    partition by: p_mfgr
+                    raw input shape:
+                    transforms raw input: true
               Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               Reduce Output Operator
                 key expressions: p_mfgr (type: string), p_name (type: string), p_size (type: int)
                 sort order: ++-
@@ -2938,6 +3197,19 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col1, _col5(DESC)
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -3001,6 +3273,25 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1, _col5(DESC)
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1, _col5
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int)
@@ -3190,7 +3481,21 @@ STAGE PLANS:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             GatherStats: false
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: part_orc
+                    output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                    type: TABLE
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: p_name
+                    output shape: p_name: string, p_mfgr: string, p_size: int, p_retailprice: double
+                    partition by: p_mfgr
+                    raw input shape:
+                    transforms raw input: true
               Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               Reduce Output Operator
                 key expressions: p_mfgr (type: string), p_name (type: string)
                 sort order: ++
@@ -3253,6 +3558,19 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -3317,6 +3635,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -3572,6 +3922,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -3636,6 +3998,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -3901,9 +4295,42 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    partition by: _col2
+                    raw input shape:
+                    transforms raw input: true
+                  Partition table definition
+                    input alias: ptf_2
+                    name: noop
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                    partition by: _col2
+                    raw input shape:
               Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 GlobalTableId: 0
@@ -3965,6 +4392,26 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -4029,6 +4476,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -4314,6 +4793,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -4378,6 +4869,30 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col5
+                        name: count
+                        window function: GenericUDAFCountEvaluator
+                        window frame: PRECEDING(MAX)~
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(2)~FOLLOWING(2)
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: bigint), _wcol1 (type: double)
@@ -4740,6 +5255,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: abc
+                  name: noop
+                  order by: _col1
+                  output shape: _col0: int, _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               isSamplingPred: false
@@ -4934,6 +5461,51 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col1
+                        name: count
+                        window function: GenericUDAFCountEvaluator
+                        window frame: PRECEDING(MAX)~
+                      window function definition
+                        alias: _wcol3
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
+                      window function definition
+                        alias: _wcol4
+                        arguments: _col5, 1, _col5
+                        name: lag
+                        window function: GenericUDAFLagEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 14 Data size: 8823 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: bigint), _col7 (type: double), _wcol3 (type: double), _col5 (type: int), (_col5 - _wcol4) (type: int)
@@ -5146,6 +5718,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int)
@@ -5529,6 +6113,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: mfgr_price_view
+                  output shape: _col0: string, _col1: string, _col2: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col0
+                  output shape: _col0: string, _col1: string, _col2: double
+                  partition by: _col0
+                  raw input shape:
             Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -5593,6 +6189,24 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1, _col2
           Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string, _col2: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(2)~
             Statistics: Num rows: 13 Data size: 8021 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col0 (type: string), _col1 (type: string), _col2 (type: double), _wcol0 (type: double)
@@ -6014,6 +6628,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col1
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -6095,6 +6721,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5, _col7
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int, _col7: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col7
+                        name: sum
+                        window function: GenericUDAFSumDouble
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _col5 (type: int), _wcol0 (type: int), _wcol1 (type: int), _wcol2 (type: double)
@@ -6198,6 +6856,24 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col5
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(5)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col1 (type: string), _col2 (type: string), _col5 (type: int), _wcol0 (type: bigint)
@@ -6266,6 +6942,45 @@ STAGE PLANS:
           outputColumnNames: _col0, _col2, _col3, _col6
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: bigint, _col2: string, _col3: string, _col6: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col3, _col2
+                  partition by: _col3
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col3, _col2
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col3, _col2
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol3
+                        arguments: _col3, _col2
+                        name: cume_dist
+                        window function: GenericUDAFCumeDistEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol4
+                        arguments: _col6, true
+                        name: first_value
+                        window function: GenericUDAFFirstValueEvaluator
+                        window frame: PRECEDING(2)~FOLLOWING(2)
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col3 (type: string), _col2 (type: string), _col6 (type: int), UDFToInteger(round(_col0, 1)) (type: int), _wcol1 (type: int), _wcol2 (type: int), _wcol3 (type: double), _wcol4 (type: int)
@@ -6661,9 +7376,49 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2, _col1
+                    raw input shape:
+                    transforms raw input: true
+                  Partition table definition
+                    input alias: ptf_2
+                    name: noop
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2, _col1
+                    raw input shape:
               Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 GlobalTableId: 0
@@ -6725,6 +7480,26 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                  transforms raw input: true
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -6789,6 +7564,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col2, _col1
+                  partition by: _col2, _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2, _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col2, _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -7105,6 +7912,25 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -7167,6 +7993,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -7229,6 +8067,18 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -7293,6 +8143,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -7592,6 +8474,25 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -7654,6 +8555,25 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -7718,6 +8638,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -8029,6 +8981,25 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -8091,9 +9062,35 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2, _col1
+                    raw input shape:
+                    transforms raw input: true
               Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 GlobalTableId: 0
@@ -8155,6 +9152,19 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                  transforms raw input: true
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -8219,6 +9229,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col2, _col1
+                  partition by: _col2, _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2, _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col2, _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint)
@@ -8561,9 +9603,42 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: _col2
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2
+                    raw input shape:
+                    transforms raw input: true
+                  Partition table definition
+                    input alias: ptf_2
+                    name: noop
+                    order by: _col2
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2
+                    raw input shape:
               Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 GlobalTableId: 0
@@ -8625,6 +9700,26 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
+                  transforms raw input: true
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -8689,6 +9784,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col2, _col1
+                  partition by: _col2, _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col2, _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col2, _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
@@ -8997,9 +10124,42 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: part_orc
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: TABLE
+                Partition table definition
+                  input alias: ptf_1
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                Partition table definition
+                  input alias: ptf_2
+                  name: noop
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             PTF Operator
+              Function definitions:
+                  Input definition
+                    input alias: ptf_0
+                    output shape: _col1: string, _col2: string, _col5: int
+                    type: PTFCOMPONENT
+                  Partition table definition
+                    input alias: ptf_1
+                    name: noopwithmap
+                    order by: _col2, _col1
+                    output shape: _col1: string, _col2: string, _col5: int
+                    partition by: _col2, _col1
+                    raw input shape:
+                    transforms raw input: true
               Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
+              Map-side function: true
               File Output Operator
                 compressed: false
                 GlobalTableId: 0
@@ -9061,6 +10221,19 @@ STAGE PLANS:
         Extract
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: PTFCOMPONENT
+                Partition table definition
+                  input alias: ptf_1
+                  name: noopwithmap
+                  order by: _col2, _col1
+                  output shape: _col1: string, _col2: string, _col5: int
+                  partition by: _col2, _col1
+                  raw input shape:
+                  transforms raw input: true
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             File Output Operator
               compressed: false
@@ -9125,6 +10298,38 @@ STAGE PLANS:
           outputColumnNames: _col1, _col2, _col5
           Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col1: string, _col2: string, _col5: int
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col2
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol1
+                        arguments: _col1
+                        name: dense_rank
+                        window function: GenericUDAFDenseRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
+                      window function definition
+                        alias: _wcol2
+                        arguments: _col5
+                        name: sum
+                        window function: GenericUDAFSumLong
+                        window frame: PRECEDING(MAX)~
             Statistics: Num rows: 26 Data size: 16042 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col2 (type: string), _col1 (type: string), _wcol0 (type: int), _wcol1 (type: int), _col5 (type: int), _wcol2 (type: bigint), _wcol2 (type: bigint)
diff --git a/ql/src/test/results/clientpositive/windowing_streaming.q.out b/ql/src/test/results/clientpositive/windowing_streaming.q.out
index 141d673..ce5215b 100644
--- a/ql/src/test/results/clientpositive/windowing_streaming.q.out
+++ b/ql/src/test/results/clientpositive/windowing_streaming.q.out
@@ -80,6 +80,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col0
+                  partition by: _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col0
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Select Operator
               expressions: _col1 (type: string), _wcol0 (type: int)
@@ -136,6 +155,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: string, _col1: string
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col0
+                  partition by: _col1
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col0
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 26 Data size: 3147 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: (_wcol0 < 4) (type: boolean)
@@ -323,6 +361,25 @@ STAGE PLANS:
           outputColumnNames: _col0, _col1
           Statistics: Num rows: 12288 Data size: 377237 Basic stats: COMPLETE Column stats: NONE
           PTF Operator
+            Function definitions:
+                Input definition
+                  input alias: ptf_0
+                  output shape: _col0: tinyint, _col1: double
+                  type: WINDOWING
+                Windowing table definition
+                  input alias: ptf_1
+                  name: windowingtablefunction
+                  order by: _col1
+                  partition by: _col0
+                  raw input shape:
+                  window functions:
+                      window function definition
+                        alias: _wcol0
+                        arguments: _col1
+                        name: rank
+                        window function: GenericUDAFRankEvaluator
+                        window frame: PRECEDING(MAX)~FOLLOWING(MAX)
+                        isPivotResult: true
             Statistics: Num rows: 12288 Data size: 377237 Basic stats: COMPLETE Column stats: NONE
             Filter Operator
               predicate: (_wcol0 < 5) (type: boolean)
-- 
1.7.9.5

